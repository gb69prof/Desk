<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Desk – La Fonte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #111827;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      background: #111827;
      color: white;
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    header h1 {
      font-size: 1rem;
      margin-right: 1rem;
      white-space: nowrap;
    }

    .toolbar-group {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      background: #1f2937;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
    }

    label {
      font-size: 0.75rem;
      opacity: 0.9;
    }

    select,
    button,
    input[type="color"] {
      font-size: 0.75rem;
      border-radius: 999px;
      border: none;
      padding: 0.2rem 0.5rem;
      outline: none;
    }

    button {
      background: #4b5563;
      color: white;
      cursor: pointer;
    }

    button:hover { background: #6b7280; }

    button.primary { background: #2563eb; }
    button.primary:hover { background: #1d4ed8; }

    button.danger { background: #b91c1c; }
    button.danger:hover { background: #991b1b; }

    button.toggle-active { background: #10b981; }

    #main {
      flex: 1;
      display: flex;
      min-height: 0;
    }

    #desk-wrapper {
      flex: 2;
      position: relative;
      display: flex;
      border-right: 1px solid #e5e7eb;
      background: #e5e7eb;
    }

    #desk-container {
      position: relative;
      flex: 1;
      margin: 0.5rem;
      border-radius: 0.75rem;
      background: #f9fafb;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.1);
      overflow: hidden;
    }

    #connections-svg {
      position: absolute;
      inset: 0;
    }

    #desk {
      position: absolute;
      inset: 0;
    }

    .node {
      position: absolute;
      min-width: 140px;
      max-width: 260px;
      padding: 0.5rem;
      border-radius: 0.75rem;
      background: white;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.15);
      border: 1px solid #e5e7eb;
      cursor: grab;
      touch-action: none;
    }

    .node:active { cursor: grabbing; }

    .node-title {
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
    }

    .node-meta {
      font-size: 0.7rem;
      color: #6b7280;
    }

    .node-buttons {
      margin-top: 0.25rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.25rem;
    }

    .node-buttons button {
      font-size: 0.65rem;
      padding: 0.15rem 0.4rem;
    }

    /* Fonte */

    #source-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 180px;
      max-width: 400px;
      transition: width 0.2s ease, opacity 0.2s ease;
      background: #111827;
      color: white;
    }

    #source-panel.hidden {
      width: 0;
      opacity: 0;
      pointer-events: none;
    }

    #source-header {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid #374151;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    #source-header h2 {
      font-size: 0.85rem;
    }

    #source-actions {
      display: flex;
      gap: 0.25rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    #source-actions button {
      font-size: 0.7rem;
      background: #374151;
    }

    #source-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 0.75rem 0.75rem;
    }

    .source-item {
      padding: 0.4rem 0.5rem;
      border-radius: 0.5rem;
      background: #1f2937;
      margin-bottom: 0.4rem;
      cursor: pointer;
      border: 1px solid transparent;
    }

    .source-item:hover {
      background: #111827;
      border-color: #4b5563;
    }

    .source-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.25rem;
      margin-bottom: 0.2rem;
    }

    .source-title {
      font-size: 0.8rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .source-delete-btn {
      font-size: 0.65rem;
      padding: 0.05rem 0.35rem;
      border-radius: 999px;
      border: none;
      background: #b91c1c;
      color: white;
      cursor: pointer;
      flex-shrink: 0;
    }

    .source-delete-btn:hover {
      background: #991b1b;
    }

    .source-url {
      font-size: 0.65rem;
      color: #9ca3af;
      word-break: break-all;
    }

    /* Modal anteprima */

    #preview-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    #preview-modal.active {
      display: flex;
    }

    #preview-content {
      background: white;
      width: min(900px, 90vw);
      height: min(600px, 80vh);
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.4);
      display: flex;
      flex-direction: column;
    }

    #preview-header {
      padding: 0.5rem 0.75rem;
      background: #111827;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      gap: 0.5rem;
    }

    #preview-header-left {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    #preview-open-tab-btn {
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      background: #4b5563;
      border: none;
    }

    #preview-open-tab-btn:hover {
      background: #6b7280;
    }

    #preview-body {
      flex: 1;
      display: flex;
      background: #f9fafb;
    }

    #preview-image-wrapper {
      flex: 1;
      display: none;
      overflow: auto;
      padding: 0.5rem;
    }

    #preview-image {
      max-width: 100%;
      max-height: 100%;
      display: block;
      margin: 0 auto;
      object-fit: contain;
    }

    #preview-frame {
      flex: 1;
      border: none;
      width: 100%;
      display: none;
    }

    #file-input,
    #load-file-input {
      display: none;
    }

    @media (max-width: 800px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      #main {
        flex-direction: column;
      }
      #desk-wrapper {
        flex: none;
        height: 55vh;
      }
      #source-panel {
        flex: none;
        height: 45vh;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
<div id="app">
  <header>
    <h1>Desk – La Fonte</h1>

    <div class="toolbar-group">
      <label>Modalità:</label>
      <button id="connect-mode-btn">Collega</button>
    </div>

    <div class="toolbar-group">
      <label for="color-picker">Colore:</label>
      <input type="color" id="color-picker" value="#111827" />
      <label for="width-select">Spessore:</label>
      <select id="width-select">
        <option value="1">Sottile</option>
        <option value="2" selected>Medio</option>
        <option value="4">Grosso</option>
      </select>
    </div>

    <div class="toolbar-group">
      <button id="save-btn" class="primary">Salva desk</button>
      <button id="load-btn">Carica desk</button>
      <button id="clear-btn" class="danger">Nuovo</button>
    </div>

    <div class="toolbar-group">
      <button id="toggle-source-btn">Mostra/nascondi Fonte</button>
    </div>
  </header>

  <div id="main">
    <div id="desk-wrapper">
      <div id="desk-container">
        <svg id="connections-svg"></svg>
        <div id="desk"></div>
      </div>
    </div>

    <aside id="source-panel">
      <div id="source-header">
        <h2>La Fonte</h2>
        <div id="source-actions">
          <button id="add-link-btn">+ Link</button>
          <button id="add-file-btn">+ File</button>
          <button id="clear-sources-btn" class="danger">Svuota fonti</button>
        </div>
      </div>
      <div id="source-list"></div>
    </aside>
  </div>
</div>

<!-- Modal anteprima -->
<div id="preview-modal">
  <div id="preview-content">
    <div id="preview-header">
      <div id="preview-header-left">
        <span id="preview-title"></span>
        <button id="preview-open-tab-btn" style="display:none;">Apri in nuova scheda</button>
      </div>
      <button id="preview-close-btn">Chiudi</button>
    </div>
    <div id="preview-body">
      <div id="preview-image-wrapper">
        <img id="preview-image" alt="Anteprima immagine" />
      </div>
      <iframe id="preview-frame"></iframe>
    </div>
  </div>
</div>

<input type="file" id="file-input" multiple />
<input type="file" id="load-file-input" accept=".json,application/json" />

<script>
  let nodes = [];
  let links = [];
  let sourceItems = [];
  let connectMode = false;
  let pendingSourceId = 0;
  let nextNodeId = 1;
  let nextLinkId = 1;
  let connectStartNode = null;
  let currentPreviewUrl = null;

  const deskEl = document.getElementById("desk");
  const connectionsSvg = document.getElementById("connections-svg");
  const sourceListEl = document.getElementById("source-list");
  const fileInputEl = document.getElementById("file-input");
  const loadFileInputEl = document.getElementById("load-file-input");

  const connectModeBtn = document.getElementById("connect-mode-btn");
  const colorPicker = document.getElementById("color-picker");
  const widthSelect = document.getElementById("width-select");

  const saveBtn = document.getElementById("save-btn");
  const loadBtn = document.getElementById("load-btn");
  const clearBtn = document.getElementById("clear-btn");
  const toggleSourceBtn = document.getElementById("toggle-source-btn");
  const sourcePanel = document.getElementById("source-panel");

  const addLinkBtn = document.getElementById("add-link-btn");
  const addFileBtn = document.getElementById("add-file-btn");
  const clearSourcesBtn = document.getElementById("clear-sources-btn");

  const previewModal = document.getElementById("preview-modal");
  const previewTitle = document.getElementById("preview-title");
  const previewFrame = document.getElementById("preview-frame");
  const previewImageWrapper = document.getElementById("preview-image-wrapper");
  const previewImage = document.getElementById("preview-image");
  const previewCloseBtn = document.getElementById("preview-close-btn");
  const previewOpenTabBtn = document.getElementById("preview-open-tab-btn");

  function createSourceId() {
    pendingSourceId += 1;
    return "source-" + pendingSourceId;
  }

  function createNodeId() {
    nextNodeId += 1;
    return "node-" + nextNodeId;
  }

  function createLinkId() {
    nextLinkId += 1;
    return "link-" + nextLinkId;
  }

  function isImageUrl(url) {
    return /\.(png|jpe?g|gif|webp|svg)$/i.test(url || "");
  }

  function renderSource() {
    sourceListEl.innerHTML = "";
    sourceItems.forEach(item => {
      const div = document.createElement("div");
      div.className = "source-item";
      div.dataset.id = item.id;

      const headerRow = document.createElement("div");
      headerRow.className = "source-header-row";

      const title = document.createElement("div");
      title.className = "source-title";
      title.textContent = item.title;

      const deleteBtn = document.createElement("button");
      deleteBtn.className = "source-delete-btn";
      deleteBtn.textContent = "✕";
      deleteBtn.title = "Elimina questa fonte";
      deleteBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        deleteSource(item.id);
      });

      headerRow.appendChild(title);
      headerRow.appendChild(deleteBtn);

      const url = document.createElement("div");
      url.className = "source-url";
      url.textContent = item.type === "url"
        ? item.url
        : "(file locale) " + item.fileName;

      div.appendChild(headerRow);
      div.appendChild(url);

      div.addEventListener("click", () => {
        const rect = deskEl.getBoundingClientRect();
        const x = rect.width / 2 - 80;
        const y = rect.height / 2 - 40;
        createNodeFromSource(item.id, x, y);
      });

      sourceListEl.appendChild(div);
    });
  }

  function createNodeFromSource(sourceId, x, y) {
    const item = sourceItems.find(s => s.id === sourceId);
    if (!item) return;

    const node = {
      id: createNodeId(),
      sourceId,
      title: item.title,
      x,
      y,
      type: item.type,
      url: item.url || null,
      fileName: item.fileName || null,
      objectUrl: item.objectUrl || null,
      mimeType: item.mimeType || null
    };
    nodes.push(node);
    renderNodes();
    renderLinks();
    saveToLocalStorageAuto();
  }

  function renderNodes() {
    deskEl.innerHTML = "";
    nodes.forEach(node => {
      const div = document.createElement("div");
      div.className = "node";
      div.style.left = node.x + "px";
      div.style.top = node.y + "px";
      div.dataset.id = node.id;

      const titleEl = document.createElement("div");
      titleEl.className = "node-title";
      titleEl.textContent = node.title;

      const metaEl = document.createElement("div");
      metaEl.className = "node-meta";
      metaEl.textContent = node.type === "url" ? "Link" : "File locale";

      const btnContainer = document.createElement("div");
      btnContainer.className = "node-buttons";

      const openBtn = document.createElement("button");
      openBtn.textContent = "Apri";
      openBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        openNode(node);
      });

      const connectBtn = document.createElement("button");
      connectBtn.textContent = "↔";
      connectBtn.title = "Usa in modalità collega";
      connectBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        nodeClickedForConnect(node);
      });

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "✕";
      deleteBtn.title = "Elimina questa card e i suoi connettori";
      deleteBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        deleteNode(node.id);
      });

      btnContainer.appendChild(openBtn);
      btnContainer.appendChild(connectBtn);
      btnContainer.appendChild(deleteBtn);

      div.appendChild(titleEl);
      div.appendChild(metaEl);
      div.appendChild(btnContainer);

      makeNodeDraggable(div, node);

      div.addEventListener("click", () => {
        if (!connectMode) {
          openNode(node);
        } else {
          nodeClickedForConnect(node);
        }
      });

      deskEl.appendChild(div);
    });
  }

  function makeNodeDraggable(el, node) {
    let isPointerDown = false;
    let startX = 0;
    let startY = 0;
    let nodeStartX = 0;
    let nodeStartY = 0;

    el.addEventListener("pointerdown", (e) => {
      if (e.button !== 0) return;
      isPointerDown = true;
      el.setPointerCapture(e.pointerId);
      startX = e.clientX;
      startY = e.clientY;
      nodeStartX = node.x;
      nodeStartY = node.y;
    });

    el.addEventListener("pointermove", (e) => {
      if (!isPointerDown) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      node.x = nodeStartX + dx;
      node.y = nodeStartY + dy;
      el.style.left = node.x + "px";
      el.style.top = node.y + "px";
      renderLinks();
    });

    el.addEventListener("pointerup", (e) => {
      isPointerDown = false;
      el.releasePointerCapture(e.pointerId);
      saveToLocalStorageAuto();
    });

    el.addEventListener("pointercancel", (e) => {
      isPointerDown = false;
      el.releasePointerCapture(e.pointerId);
    });
  }

  function deleteNode(nodeId) {
    if (!confirm("Eliminare questa card e i suoi connettori?")) return;
    nodes = nodes.filter(n => n.id !== nodeId);
    links = links.filter(l => l.from !== nodeId && l.to !== nodeId);
    renderNodes();
    renderLinks();
    saveToLocalStorageAuto();
  }

  function deleteSource(sourceId) {
    if (!confirm("Eliminare questa fonte dalla lista? Le card sul desk resteranno.")) return;
    sourceItems = sourceItems.filter(s => s.id !== sourceId);
    renderSource();
    saveToLocalStorageAuto();
  }

  function clearSources() {
    if (!sourceItems.length) return;
    if (!confirm("Vuoi davvero svuotare tutte le fonti? Le card già sul desk resteranno.")) return;
    sourceItems = [];
    renderSource();
    saveToLocalStorageAuto();
  }

  function nodeClickedForConnect(node) {
    if (!connectMode) return;
    if (!connectStartNode) {
      connectStartNode = node;
    } else {
      if (connectStartNode.id !== node.id) {
        const link = {
          id: createLinkId(),
          from: connectStartNode.id,
          to: node.id,
          color: colorPicker.value,
          width: parseInt(widthSelect.value, 10)
        };
        links.push(link);
        renderLinks();
        saveToLocalStorageAuto();
      }
      connectStartNode = null;
    }
  }

  function renderLinks() {
    const rect = deskEl.getBoundingClientRect();
    connectionsSvg.setAttribute("width", rect.width);
    connectionsSvg.setAttribute("height", rect.height);
    connectionsSvg.innerHTML = "";

    links.forEach(link => {
      const fromNode = nodes.find(n => n.id === link.from);
      const toNode = nodes.find(n => n.id === link.to);
      if (!fromNode || !toNode) return;

      const x1 = fromNode.x + 70;
      const y1 = fromNode.y + 30;
      const x2 = toNode.x + 70;
      const y2 = toNode.y + 30;

      const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      line.setAttribute("x1", x1);
      line.setAttribute("y1", y1);
      line.setAttribute("x2", x2);
      line.setAttribute("y2", y2);
      line.setAttribute("stroke", link.color || "#111827");
      line.setAttribute("stroke-width", link.width || 2);
      line.setAttribute("stroke-linecap", "round");
      line.dataset.id = link.id;

      line.addEventListener("click", (e) => {
        e.stopPropagation();
        handleLinkClick(link.id);
      });

      connectionsSvg.appendChild(line);
    });
  }

  function handleLinkClick(linkId) {
    const link = links.find(l => l.id === linkId);
    if (!link) return;

    const choice = prompt("Connettore:\n1 = cambia colore\n2 = elimina\n(Annulla per uscire)");
    if (choice === null) return;

    if (choice.trim() === "1") {
      link.color = colorPicker.value;
      renderLinks();
      saveToLocalStorageAuto();
    } else if (choice.trim() === "2") {
      links = links.filter(l => l.id !== linkId);
      renderLinks();
      saveToLocalStorageAuto();
    }
  }

  function openNode(node) {
    previewTitle.textContent = node.title;
    previewFrame.style.display = "none";
    previewImageWrapper.style.display = "none";
    previewFrame.src = "about:blank";
    previewImage.src = "";
    currentPreviewUrl = null;
    previewOpenTabBtn.style.display = "none";

    const mime = (node.mimeType || "").toLowerCase();
    const isLocalImage = node.type === "file" && mime.startsWith("image/");
    const isRemoteImage = node.type === "url" && isImageUrl(node.url);

    if (isLocalImage || isRemoteImage) {
      const src = node.type === "file" ? node.objectUrl : node.url;
      previewImageWrapper.style.display = "block";
      previewImage.src = src;
      currentPreviewUrl = src;
      previewOpenTabBtn.style.display = "inline-block";
    } else {
      let src = null;
      if (node.type === "url" && node.url) {
        src = node.url;
      } else if (node.type === "file" && node.objectUrl) {
        src = node.objectUrl;
      }
      if (src) {
        previewFrame.src = src;
        previewFrame.style.display = "block";
        currentPreviewUrl = src;
        previewOpenTabBtn.style.display = "inline-block";
      }
    }

    previewModal.classList.add("active");
  }

  previewCloseBtn.addEventListener("click", () => {
    previewModal.classList.remove("active");
    previewFrame.src = "about:blank";
    previewImage.src = "";
    currentPreviewUrl = null;
  });

  previewModal.addEventListener("click", (e) => {
    if (e.target === previewModal) {
      previewModal.classList.remove("active");
      previewFrame.src = "about:blank";
      previewImage.src = "";
      currentPreviewUrl = null;
    }
  });

  previewOpenTabBtn.addEventListener("click", () => {
    if (currentPreviewUrl) {
      window.open(currentPreviewUrl, "_blank");
    }
  });

  connectModeBtn.addEventListener("click", () => {
    connectMode = !connectMode;
    connectStartNode = null;
    if (connectMode) {
      connectModeBtn.classList.add("toggle-active");
    } else {
      connectModeBtn.classList.remove("toggle-active");
    }
  });

  /* --- SALVATAGGIO: file JSON in Download + autosalvataggio locale --- */

  function saveToLocalStorageAuto() {
    const data = { nodes, links, sourceItems };
    try {
      localStorage.setItem("desk-la-fonte", JSON.stringify(data));
    } catch (e) {
      // se localStorage è pieno o bloccato, pazienza
    }
  }

  function downloadDesk() {
    const data = { nodes, links, sourceItems };
    const blob = new Blob([JSON.stringify(data)], { type: "application/json" });

    const now = new Date();
    const pad = n => String(n).padStart(2, "0");
    const name =
      "desk-la-fonte-" +
      now.getFullYear() +
      pad(now.getMonth() + 1) +
      pad(now.getDate()) +
      "-" +
      pad(now.getHours()) +
      pad(now.getMinutes()) +
      ".json";

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = name;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    alert("Desk esportato come file JSON (controlla la cartella Download).");
  }

  function uploadDesk() {
    loadFileInputEl.value = "";
    loadFileInputEl.click();
  }

  loadFileInputEl.addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        nodes = data.nodes || [];
        links = data.links || [];
        sourceItems = data.sourceItems || [];

        let maxNode = 0;
        let maxLink = 0;
        let maxSource = 0;

        nodes.forEach(n => {
          const m = String(n.id || "").match(/node-(\d+)/);
          if (m) maxNode = Math.max(maxNode, parseInt(m[1], 10));
        });
        links.forEach(l => {
          const m = String(l.id || "").match(/link-(\d+)/);
          if (m) maxLink = Math.max(maxLink, parseInt(m[1], 10));
        });
        sourceItems.forEach(s => {
          const m = String(s.id || "").match(/source-(\d+)/);
          if (m) maxSource = Math.max(maxSource, parseInt(m[1], 10));
        });

        nextNodeId = maxNode || 1;
        nextLinkId = maxLink || 1;
        pendingSourceId = maxSource || 0;

        renderSource();
        renderNodes();
        renderLinks();
        saveToLocalStorageAuto();
        alert("Desk caricato dal file.");
      } catch (err) {
        console.error(err);
        alert("File non valido (JSON corrotto o formato errato).");
      }
    };
    reader.readAsText(file);
  });

  /* --- CLEAR DESK --- */

  function clearDesk() {
    if (!confirm("Vuoi davvero azzerare il desk (card e connettori)? Le fonti resteranno.")) return;
    nodes = [];
    links = [];
    renderNodes();
    renderLinks();
    saveToLocalStorageAuto();
  }

  saveBtn.addEventListener("click", downloadDesk);
  loadBtn.addEventListener("click", uploadDesk);
  clearBtn.addEventListener("click", clearDesk);

  toggleSourceBtn.addEventListener("click", () => {
    sourcePanel.classList.toggle("hidden");
  });

  addLinkBtn.addEventListener("click", () => {
    const title = prompt("Titolo del materiale:");
    if (!title) return;
    let url = prompt("URL (pagina web, GitHub, Google Drive, YouTube, ecc.):");
    if (!url) return;
    url = url.trim();
    if (!/^https?:\/\//i.test(url)) {
      url = "https://" + url;
    }
    const item = {
      id: createSourceId(),
      type: "url",
      title,
      url
    };
    sourceItems.push(item);
    renderSource();
    saveToLocalStorageAuto();
  });

  addFileBtn.addEventListener("click", () => {
    fileInputEl.value = "";
    fileInputEl.click();
  });

  fileInputEl.addEventListener("change", (e) => {
    const files = Array.from(e.target.files || []);
    files.forEach(file => {
      const objectUrl = URL.createObjectURL(file);
      const item = {
        id: createSourceId(),
        type: "file",
        title: file.name,
        fileName: file.name,
        objectUrl,
        mimeType: file.type || ""
      };
      sourceItems.push(item);
    });
    renderSource();
    saveToLocalStorageAuto();
  });

  clearSourcesBtn.addEventListener("click", clearSources);

  /* --- INIT --- */

  function loadFromLocalStorage() {
    const raw = localStorage.getItem("desk-la-fonte");
    if (!raw) return;
    try {
      const data = JSON.parse(raw);
      nodes = data.nodes || [];
      links = data.links || [];
      sourceItems = data.sourceItems || [];

      let maxNode = 0;
      let maxLink = 0;
      let maxSource = 0;

      nodes.forEach(n => {
        const m = String(n.id || "").match(/node-(\d+)/);
        if (m) maxNode = Math.max(maxNode, parseInt(m[1], 10));
      });
      links.forEach(l => {
        const m = String(l.id || "").match(/link-(\d+)/);
        if (m) maxLink = Math.max(maxLink, parseInt(m[1], 10));
      });
      sourceItems.forEach(s => {
        const m = String(s.id || "").match(/source-(\d+)/);
        if (m) maxSource = Math.max(maxSource, parseInt(m[1], 10));
      });

      nextNodeId = maxNode || 1;
      nextLinkId = maxLink || 1;
      pendingSourceId = maxSource || 0;

      renderSource();
      renderNodes();
      renderLinks();
    } catch (e) {
      console.error(e);
    }
  }

  function initExample() {
    // Da ora in poi: niente esempi.
    // Se c'è qualcosa in localStorage, lo carico; altrimenti lascio tutto vuoto.
    loadFromLocalStorage();
  }

  window.addEventListener("resize", renderLinks);

  initExample();
</script>
</body>
</html>
