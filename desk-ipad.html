<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Desk interattivo iPad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg-app: #f4f5f7;
      --bg-canvas: #f9fafb;
      --card-bg: #ffffff;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.12);
      --border-subtle: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --shadow-soft: 0 12px 30px rgba(15, 23, 42, 0.12);
      --radius-card: 20px;
      --radius-pill: 999px;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: var(--bg-app);
      -webkit-user-select: none;
      user-select: none;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* Barra superiore */
    .topbar {
      height: 52px;
      padding: 0 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(to right, #f9fafb, #e5e7eb);
      border-bottom: 1px solid rgba(148,163,184,0.5);
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .app-logo {
      width: 24px;
      height: 24px;
      border-radius: 10px;
      background: radial-gradient(circle at 0 0, #a855f7, #3b82f6);
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.25);
    }

    .app-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #0f172a;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pill-button {
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: #ffffff;
      padding: 5px 12px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      color: var(--text-muted);
      transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.08s ease;
    }

    .pill-button .icon {
      font-size: 14px;
      line-height: 1;
    }

    .pill-button:hover {
      background: #f3f4f6;
      box-shadow: 0 4px 10px rgba(148, 163, 184, 0.3);
      transform: translateY(-1px);
    }

    .pill-button.danger {
      border-color: rgba(239,68,68,0.8);
      color: #b91c1c;
    }

    .main {
      flex: 1;
      display: flex;
      padding: 8px;
      gap: 8px;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      min-width: 230px;
      background: #f9fafb;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .sidebar-section {
      border-radius: 12px;
      padding: 8px;
      border: 1px dashed rgba(148,163,184,0.5);
      background: #ffffff;
    }

    .sidebar-title {
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #6b7280;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .sidebar-title span.badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(37,99,235,0.08);
      color: #1d4ed8;
      border: 1px solid rgba(37,99,235,0.25);
    }

    .tool-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
    }

    .tool-button {
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: #ffffff;
      box-shadow: 0 3px 9px rgba(15, 23, 42, 0.06);
      padding: 6px 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: background 0.12s ease, transform 0.08s ease, box-shadow 0.12s ease;
    }

    .tool-button:active {
      transform: scale(0.98);
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.18);
    }

    .tool-main {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tool-icon {
      width: 24px;
      height: 24px;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .tool-icon.text  { background: rgba(59,130,246,0.12); color: #1d4ed8; }
    .tool-icon.image { background: rgba(16,185,129,0.12); color: #047857; }
    .tool-icon.pdf   { background: rgba(239,68,68,0.12); color: #b91c1c; }
    .tool-icon.web   { background: rgba(234,179,8,0.12);  color: #92400e; }
    .tool-icon.video { background: rgba(147,51,234,0.12); color: #6b21a8; }

    .tool-text-title {
      font-size: 13px;
      font-weight: 600;
    }

    .tool-text-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .tool-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px dashed rgba(148, 163, 184, 0.8);
      color: #6b7280;
    }

    .fonti-list {
      max-height: 180px;
      overflow: auto;
      padding-right: 4px;
    }

    .fonte-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      padding: 4px 0;
      border-bottom: 1px dashed rgba(209,213,219,0.8);
    }

    .fonte-main {
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 0;
    }

    .fonte-icon {
      width: 20px;
      height: 20px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .fonte-title {
      font-size: 11px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 130px;
    }

    .fonte-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }

    .fonte-btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.8);
      background: #f9fafb;
      font-size: 10px;
      padding: 2px 6px;
      cursor: pointer;
    }

    .fonte-btn.danger {
      border-color: rgba(239,68,68,0.8);
      color: #b91c1c;
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 11px;
      color: var(--text-muted);
      border-top: 1px dashed rgba(148, 163, 184, 0.6);
      padding-top: 6px;
    }

    /* Canvas */
    .canvas {
      flex: 1;
      position: relative;
      border-radius: 20px;
      background:
        radial-gradient(circle at 0 0, rgba(129, 140, 248, 0.18), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(45, 212, 191, 0.18), transparent 55%),
        var(--bg-canvas);
      border: 1px solid rgba(148,163,184,0.4);
      box-shadow: 0 16px 36px rgba(15, 23, 42, 0.2);
      overflow: hidden;
      position: relative;
      touch-action: none; /* per drag/resize fluido su iPad */
    }

    .canvas-grid {
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(to right, rgba(148,163,184,0.16) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(148,163,184,0.12) 1px, transparent 1px);
      background-size: 32px 32px;
      opacity: 0.35;
      pointer-events: none;
    }

    .connector-layer {
      position: absolute;
      inset: 0;
      pointer-events: auto;
      z-index: 1;
    }

    .connector-path {
      fill: none;
      stroke: var(--accent);
      stroke-width: 2.2;
      stroke-linecap: round;
      cursor: pointer;
      transition: stroke 0.12s ease, stroke-width 0.12s ease;
    }

    .connector-path:hover,
    .connector-path.selected {
      stroke: #f97316;
      stroke-width: 3;
    }

    .desk-card {
      position: absolute;
      min-width: 220px;
      min-height: 140px;
      max-width: 620px;
      background: var(--card-bg);
      border-radius: var(--radius-card);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid rgba(148,163,184,0.35);
      transition: box-shadow 0.12s ease, transform 0.08s ease, border-color 0.12s ease;
      z-index: 2;
      touch-action: none;
    }

    .desk-card.selected {
      border-color: var(--accent);
      box-shadow: 0 16px 40px rgba(37,99,235,0.32);
      transform: translateY(-1px);
    }

    .desk-card.connecting-source {
      border-color: #f97316;
      box-shadow: 0 16px 40px rgba(249,115,22,0.35);
    }

    .card-header {
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 8px 0 10px;
      background: linear-gradient(to right, rgba(15,23,42,0.04), rgba(148,163,184,0.04));
      border-bottom: 1px solid rgba(148,163,184,0.35);
      position: relative;
      z-index: 3;
    }

    .card-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      overflow: hidden;
    }

    .card-type-icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      background: rgba(59,130,246,0.15);
      color: #1d4ed8;
    }

    .card-title {
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 120px;
    }

    .card-header-actions {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .icon-button {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 13px;
      color: #6b7280;
      transition: background 0.12s ease, color 0.12s ease, transform 0.08s ease;
    }

    .icon-button:active {
      transform: scale(0.9);
      background: rgba(148,163,184,0.3);
    }

    .icon-button.danger:active {
      background: rgba(248,113,113,0.2);
      color: #b91c1c;
    }

    .card-body {
      flex: 1;
      padding: 8px 10px 8px 10px;
      overflow: hidden;
      display: flex;
      align-items: stretch;
      justify-content: stretch;
      position: relative;
      z-index: 2;
    }

    .card-body-inner {
      width: 100%;
      height: 100%;
      overflow: auto;
      border-radius: 12px;
      background: #f9fafb;
      padding: 4px;
      touch-action: auto;
    }

    .card-text-content {
      width: 100%;
      min-height: 80px;
      font-size: 13px;
      line-height: 1.5;
      outline: none;
      border-radius: 10px;
      border: 1px solid rgba(209,213,219,0.8);
      padding: 6px 6px 10px 6px;
      background: #ffffff;
      -webkit-user-select: text;
      user-select: text;
      touch-action: auto;
    }

    .card-iframe,
    .card-embed {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 10px;
      background: #020617;
    }

    .card-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 10px;
      background: #020617;
    }

    .resize-handle {
      position: absolute;
      width: 16px;
      height: 16px;
      right: 6px;
      bottom: 6px;
      border-radius: 4px;
      background: rgba(15,23,42,0.06);
      border: 1px solid rgba(148,163,184,0.9);
      cursor: se-resize;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #6b7280;
      z-index: 4;
      touch-action: none;
    }

    .resize-handle::before {
      content: "";
      width: 8px;
      height: 8px;
      border-right: 1px solid rgba(107,114,128,0.9);
      border-bottom: 1px solid rgba(107,114,128,0.9);
      transform: translate(1px, 1px);
    }

    .connector-handle {
      position: absolute;
      width: 14px;
      height: 14px;
      right: -7px;
      top: 50%;
      transform: translateY(-50%);
      border-radius: 999px;
      background: var(--accent-soft);
      border: 1px solid rgba(37,99,235,0.9);
      cursor: crosshair;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
      box-shadow: 0 0 0 2px rgba(248,250,252,0.9);
      touch-action: none;
    }

    .connector-handle::before {
      content: "";
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: var(--accent);
    }

    .desk-card.collapsed {
      height: 40px !important;
    }
    .desk-card.collapsed .card-body { display: none; }
    .desk-card.collapsed .resize-handle { display: none; }

    input[type="file"] { display: none; }

    @media (max-width: 900px) {
      .sidebar { display: none; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="topbar-left">
        <div class="app-logo"></div>
        <div class="app-title">Desk interattivo</div>
      </div>
      <div class="topbar-right">
        <button class="pill-button danger" id="btn-clear-connectors">
          <span class="icon">üóëÔ∏è</span><span>Connettori</span>
        </button>
        <button class="pill-button" id="btn-clear">
          <span class="icon">üßπ</span><span>Nuovo desk</span>
        </button>
      </div>
    </header>

    <main class="main">
      <aside class="sidebar">
        <!-- Strumenti -->
        <div class="sidebar-section">
          <div class="sidebar-title">
            Strumenti
            <span class="badge">Desk</span>
          </div>
          <div class="tool-list">
            <button class="tool-button" id="tool-text">
              <div class="tool-main">
                <div class="tool-icon text">T</div>
                <div>
                  <div class="tool-text-title">Nota di testo</div>
                  <div class="tool-text-sub">Subito sul desk</div>
                </div>
              </div>
              <div class="tool-badge">TXT</div>
            </button>
          </div>
        </div>

        <!-- Fonti / deposito -->
        <div class="sidebar-section">
          <div class="sidebar-title">
            Fonti
            <span class="badge">Archivio</span>
          </div>
          <div class="tool-list" style="margin-bottom:6px;">
            <label class="tool-button" id="btn-add-image">
              <div class="tool-main">
                <div class="tool-icon image">üñºÔ∏è</div>
                <div>
                  <div class="tool-text-title">Immagine</div>
                  <div class="tool-text-sub">Da device</div>
                </div>
              </div>
              <div class="tool-badge">IMG</div>
            </label>

            <label class="tool-button" id="btn-add-pdf">
              <div class="tool-main">
                <div class="tool-icon pdf">üìÑ</div>
                <div>
                  <div class="tool-text-title">PDF</div>
                  <div class="tool-text-sub">Da device</div>
                </div>
              </div>
              <div class="tool-badge">PDF</div>
            </label>

            <button class="tool-button" id="btn-add-web">
              <div class="tool-main">
                <div class="tool-icon web">üåê</div>
                <div>
                  <div class="tool-text-title">Pagina web</div>
                  <div class="tool-text-sub">URL nel deposito</div>
                </div>
              </div>
              <div class="tool-badge">URL</div>
            </button>

            <button class="tool-button" id="btn-add-video">
              <div class="tool-main">
                <div class="tool-icon video">‚ñ∂Ô∏è</div>
                <div>
                  <div class="tool-text-title">Video</div>
                  <div class="tool-text-sub">YouTube, HeyGen‚Ä¶</div>
                </div>
              </div>
              <div class="tool-badge">VID</div>
            </button>
          </div>

          <div class="fonti-list" id="fonti-list">
            <!-- vuoto all'avvio -->
          </div>
        </div>

        <div class="sidebar-footer">
          ‚ûú Le fonti restano nel deposito.<br>
          ‚ûú Con ‚Äú‚ûï Desk‚Äù le trasformi in card spostabili.<br>
          ‚ûú Pallino blu ‚Üí connetti le card.
        </div>

        <input type="file" id="input-image" accept="image/*">
        <input type="file" id="input-pdf" accept="application/pdf">
      </aside>

      <section class="canvas" id="canvas">
        <svg id="connector-layer" class="connector-layer" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%"></svg>
        <div class="canvas-grid"></div>
      </section>
    </main>
  </div>

  <script>
    (function() {
      const canvas = document.getElementById('canvas');
      const connectorLayer = document.getElementById('connector-layer');

      const toolText = document.getElementById('tool-text');
      const btnClear = document.getElementById('btn-clear');
      const btnClearConnectors = document.getElementById('btn-clear-connectors');

      const btnAddImage = document.getElementById('btn-add-image');
      const btnAddPdf = document.getElementById('btn-add-pdf');
      const btnAddWeb = document.getElementById('btn-add-web');
      const btnAddVideo = document.getElementById('btn-add-video');

      const inputImage = document.getElementById('input-image');
      const inputPdf = document.getElementById('input-pdf');
      const fontiList = document.getElementById('fonti-list');

      let zIndexCounter = 10;
      let cardIdCounter = 0;
      let fonteIdCounter = 0;
      let currentSelectedCard = null;

      let connectors = [];
      let connectorStartCard = null;

      const hasPointer = window.PointerEvent !== undefined;
      const fonti = [];

      /* --- Drag helper (mouse + touch + pointer) --- */
      function addDrag(handle, onStart, onMove, onEnd) {
        let active = false;
        let lastX = 0;
        let lastY = 0;

        function start(x, y, rawEvent) {
          active = true;
          lastX = x;
          lastY = y;
          if (onStart) onStart(rawEvent);
        }

        function move(x, y, rawEvent) {
          if (!active) return;
          const dx = x - lastX;
          const dy = y - lastY;
          lastX = x;
          lastY = y;
          onMove(dx, dy, rawEvent);
        }

        function end(rawEvent) {
          if (!active) return;
          active = false;
          if (onEnd) onEnd(rawEvent);
        }

        if (hasPointer) {
          handle.addEventListener('pointerdown', (e) => {
            if (e.button !== 0 && e.button !== undefined) return;
            handle.setPointerCapture(e.pointerId);
            start(e.clientX, e.clientY, e);
            e.preventDefault();
          });
          handle.addEventListener('pointermove', (e) => {
            if (!active) return;
            move(e.clientX, e.clientY, e);
          });
          handle.addEventListener('pointerup', (e) => {
            end(e);
            try { handle.releasePointerCapture(e.pointerId); } catch (_) {}
          });
          handle.addEventListener('pointercancel', (e) => {
            end(e);
            try { handle.releasePointerCapture(e.pointerId); } catch (_) {}
          });
        } else {
          handle.addEventListener('mousedown', (e) => {
            if (e.button !== 0) return;
            start(e.clientX, e.clientY, e);
            document.addEventListener('mousemove', mouseMove);
            document.addEventListener('mouseup', mouseUp);
            e.preventDefault();
          });
          function mouseMove(e) {
            move(e.clientX, e.clientY, e);
          }
          function mouseUp(e) {
            document.removeEventListener('mousemove', mouseMove);
            document.removeEventListener('mouseup', mouseUp);
            end(e);
          }

          handle.addEventListener('touchstart', (e) => {
            const t = e.touches[0];
            if (!t) return;
            start(t.clientX, t.clientY, e);
            document.addEventListener('touchmove', touchMove, { passive: false });
            document.addEventListener('touchend', touchEnd);
            e.preventDefault();
          });
          function touchMove(e) {
            const t = e.touches[0];
            if (!t) return;
            move(t.clientX, t.clientY, e);
            e.preventDefault();
          }
          function touchEnd(e) {
            document.removeEventListener('touchmove', touchMove);
            document.removeEventListener('touchend', touchEnd);
            end(e);
          }
        }
      }

      function bringToFront(card) {
        zIndexCounter++;
        card.style.zIndex = zIndexCounter;
        if (currentSelectedCard && currentSelectedCard !== card) {
          currentSelectedCard.classList.remove('selected');
        }
        card.classList.add('selected');
        currentSelectedCard = card;
        updateConnectors();
      }

      function toggleCollapse(card, btn) {
        const isCollapsed = card.classList.contains('collapsed');
        if (isCollapsed) {
          card.classList.remove('collapsed');
          if (card.dataset.prevHeight) {
            card.style.height = card.dataset.prevHeight;
          }
          btn.innerHTML = '‚ñæ';
        } else {
          card.dataset.prevHeight = card.style.height || (card.getBoundingClientRect().height + 'px');
          card.classList.add('collapsed');
          btn.innerHTML = '‚ñ¥';
        }
        updateConnectors();
      }

      function toggleMaximize(card) {
        const isMax = card.classList.contains('maximized');
        const canvasRect = canvas.getBoundingClientRect();
        if (!isMax) {
          const rect = card.getBoundingClientRect();
          card.dataset.prevLeft = card.style.left || (card.offsetLeft + 'px');
          card.dataset.prevTop = card.style.top || (card.offsetTop + 'px');
          card.dataset.prevWidth = card.style.width || (rect.width + 'px');
          card.dataset.prevHeight = card.style.height || (rect.height + 'px');

          const targetWidth = canvasRect.width * 0.85;
          const targetHeight = canvasRect.height * 0.85;
          const left = (canvasRect.width - targetWidth) / 2;
          const top = (canvasRect.height - targetHeight) / 2;

          card.style.left = left + 'px';
          card.style.top = top + 'px';
          card.style.width = targetWidth + 'px';
          card.style.height = targetHeight + 'px';
          card.classList.add('maximized');
        } else {
          if (card.dataset.prevLeft) card.style.left = card.dataset.prevLeft;
          if (card.dataset.prevTop) card.style.top = card.dataset.prevTop;
          if (card.dataset.prevWidth) card.style.width = card.dataset.prevWidth;
          if (card.dataset.prevHeight) card.style.height = card.dataset.prevHeight;
          card.classList.remove('maximized');
        }
        updateConnectors();
      }

      function handleConnectorClick(card) {
        if (!connectorStartCard) {
          connectorStartCard = card;
          card.classList.add('connecting-source');
          bringToFront(card);
        } else if (connectorStartCard === card) {
          connectorStartCard.classList.remove('connecting-source');
          connectorStartCard = null;
        } else {
          connectorStartCard.classList.remove('connecting-source');
          createConnector(connectorStartCard, card);
          connectorStartCard = null;
        }
      }

      function createConnector(fromCard, toCard) {
        const fromId = fromCard.dataset.cardId;
        const toId = toCard.dataset.cardId;
        if (!fromId || !toId || fromId === toId) return;

        if (connectors.some(c => c.fromId === fromId && c.toId === toId)) return;

        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('class', 'connector-path');

        const id = 'conn-' + Date.now() + '-' + Math.random().toString(36).slice(2);
        path.dataset.connectorId = id;
        connectorLayer.appendChild(path);

        const conn = { id, fromId, toId, pathEl: path };
        connectors.push(conn);

        path.addEventListener('click', () => {
          removeConnectorById(id);
        });

        updateConnectors();
      }

      function removeConnectorById(id) {
        const idx = connectors.findIndex(c => c.id === id);
        if (idx === -1) return;
        const conn = connectors[idx];
        if (conn.pathEl && conn.pathEl.parentNode) {
          conn.pathEl.parentNode.removeChild(conn.pathEl);
        }
        connectors.splice(idx, 1);
      }

      function removeConnectorsForCard(cardId) {
        const remaining = [];
        connectors.forEach(c => {
          if (c.fromId === cardId || c.toId === cardId) {
            if (c.pathEl && c.pathEl.parentNode) {
              c.pathEl.parentNode.removeChild(c.pathEl);
            }
          } else {
            remaining.push(c);
          }
        });
        connectors = remaining;
      }

      function clearAllConnectors() {
        connectors.forEach(c => {
          if (c.pathEl && c.pathEl.parentNode) {
            c.pathEl.parentNode.removeChild(c.pathEl);
          }
        });
        connectors = [];
      }

      /* QUI semplifico: uso offsetLeft/top (coordinate nel canvas) */
      function updateConnectors() {
        const toRemove = [];

        connectors.forEach(conn => {
          const fromCard = canvas.querySelector('.desk-card[data-card-id="' + conn.fromId + '"]');
          const toCard   = canvas.querySelector('.desk-card[data-card-id="' + conn.toId + '"]');
          if (!fromCard || !toCard) {
            toRemove.push(conn.id);
            return;
          }

          const fromLeft = fromCard.offsetLeft;
          const fromTop  = fromCard.offsetTop;
          const fromW    = fromCard.offsetWidth;
          const fromH    = fromCard.offsetHeight;

          const toLeft = toCard.offsetLeft;
          const toTop  = toCard.offsetTop;
          const toW    = toCard.offsetWidth;
          const toH    = toCard.offsetHeight;

          const startX = fromLeft + fromW;
          const startY = fromTop + fromH / 2;
          const endX   = toLeft;
          const endY   = toTop + toH / 2;

          const offset = Math.max(40, Math.abs(endX - startX) / 3);

          const d = [
            'M', startX, startY,
            'C', startX + offset, startY,
                 endX - offset, endY,
                 endX, endY
          ].join(' ');

          conn.pathEl.setAttribute('d', d);
        });

        toRemove.forEach(removeConnectorById);
      }

      window.addEventListener('resize', updateConnectors);

      function createCardBase(type, title) {
        const card = document.createElement('div');
        card.className = 'desk-card';
        card.dataset.cardId = String(++cardIdCounter);
        card.dataset.type = type;
        card.style.left = (40 + Math.random() * 80) + 'px';
        card.style.top = (40 + Math.random() * 80) + 'px';
        card.style.width = '320px';
        card.style.height = '220px';
        card.style.zIndex = zIndexCounter;

        const header = document.createElement('div');
        header.className = 'card-header';

        const headerLeft = document.createElement('div');
        headerLeft.className = 'card-header-left';

        const icon = document.createElement('div');
        icon.className = 'card-type-icon';
        icon.textContent =
          type === 'text'  ? 'T' :
          type === 'image' ? 'IMG' :
          type === 'pdf'   ? 'PDF' :
          type === 'web'   ? 'WWW' :
          type === 'video' ? 'VID' : '?';

        const titleEl = document.createElement('div');
        titleEl.className = 'card-title';
        titleEl.textContent = title || 'Elemento';

        headerLeft.appendChild(icon);
        headerLeft.appendChild(titleEl);

        const headerActions = document.createElement('div');
        headerActions.className = 'card-header-actions';

        const toggleButton = document.createElement('button');
        toggleButton.className = 'icon-button';
        toggleButton.title = 'Apri/chiudi';
        toggleButton.innerHTML = '‚ñæ';

        const maxButton = document.createElement('button');
        maxButton.className = 'icon-button';
        maxButton.title = 'Ingrandisci/ripristina';
        maxButton.innerHTML = '‚§¢';

        const closeButton = document.createElement('button');
        closeButton.className = 'icon-button danger';
        closeButton.title = 'Elimina';
        closeButton.innerHTML = '‚úï';

        headerActions.appendChild(toggleButton);
        headerActions.appendChild(maxButton);
        headerActions.appendChild(closeButton);

        header.appendChild(headerLeft);
        header.appendChild(headerActions);

        const body = document.createElement('div');
        body.className = 'card-body';

        const bodyInner = document.createElement('div');
        bodyInner.className = 'card-body-inner';
        body.appendChild(bodyInner);

        const resize = document.createElement('div');
        resize.className = 'resize-handle';

        const connectorHandle = document.createElement('div');
        connectorHandle.className = 'connector-handle';

        card.appendChild(header);
        card.appendChild(body);
        card.appendChild(resize);
        card.appendChild(connectorHandle);

        canvas.appendChild(card);

        /* drag card */
        addDrag(
          header,
          () => bringToFront(card),
          (dx, dy) => {
            const left = card.offsetLeft + dx;
            const top  = card.offsetTop  + dy;
            card.style.left = left + 'px';
            card.style.top  = top  + 'px';
            updateConnectors();
          }
        );

        /* resize */
        addDrag(
          resize,
          () => bringToFront(card),
          (dx, dy) => {
            const newWidth  = Math.max(220, card.offsetWidth  + dx);
            const newHeight = Math.max(140, card.offsetHeight + dy);
            card.style.width  = newWidth  + 'px';
            card.style.height = newHeight + 'px';
            updateConnectors();
          }
        );

        /* selezione */
        card.addEventListener('pointerdown', () => bringToFront(card));
        card.addEventListener('mousedown', () => bringToFront(card));

        /* apri/chiudi contenuto */
        toggleButton.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleCollapse(card, toggleButton);
        });

        /* ingrandisci/ripristina */
        maxButton.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleMaximize(card);
        });

        /* chiudi card */
        closeButton.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = card.dataset.cardId;
          removeConnectorsForCard(id);
          card.remove();
          if (currentSelectedCard === card) currentSelectedCard = null;
          updateConnectors();
        });

        /* connettore */
        connectorHandle.addEventListener('click', (e) => {
          e.stopPropagation();
          handleConnectorClick(card);
        });

        return { card, bodyInner, titleEl };
      }

      function createTextCard(initialText) {
        const { card, bodyInner } = createCardBase('text', 'Nota');
        const text = document.createElement('div');
        text.className = 'card-text-content';
        text.contentEditable = 'true';
        text.innerHTML = initialText || '';
        bodyInner.appendChild(text);
        bringToFront(card);
        updateConnectors();
        return card;
      }

      function createCardFromFonte(fonte) {
        let baseTitle = fonte.title || 'Elemento';
        const { card, bodyInner, titleEl } = createCardBase(fonte.type, baseTitle);

        if (fonte.type === 'image') {
          const img = document.createElement('img');
          img.className = 'card-image';
          img.src = fonte.dataUrl;
          bodyInner.appendChild(img);
        } else if (fonte.type === 'pdf') {
          const iframe = document.createElement('iframe');
          iframe.className = 'card-embed';
          iframe.src = fonte.dataUrl;
          bodyInner.appendChild(iframe);
        } else if (fonte.type === 'web' || fonte.type === 'video') {
          const iframe = document.createElement('iframe');
          iframe.className = 'card-iframe';
          iframe.src = fonte.url;
          iframe.setAttribute('allowfullscreen', 'true');
          iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');
          bodyInner.appendChild(iframe);
          titleEl.textContent = fonte.shortTitle || baseTitle;
        }

        bringToFront(card);
        updateConnectors();
        return card;
      }

      /* Fonti / deposito */

      function addFonteToList(fonte) {
        const row = document.createElement('div');
        row.className = 'fonte-item';
        row.dataset.fonteId = fonte.id;

        const main = document.createElement('div');
        main.className = 'fonte-main';

        const icon = document.createElement('div');
        icon.className = 'fonte-icon';
        icon.textContent =
          fonte.type === 'image' ? 'üñºÔ∏è' :
          fonte.type === 'pdf'   ? 'üìÑ' :
          fonte.type === 'web'   ? 'üåê' :
          fonte.type === 'video' ? '‚ñ∂Ô∏è' : '?';

        const title = document.createElement('div');
        title.className = 'fonte-title';
        title.textContent = fonte.shortTitle || fonte.title || fonte.type.toUpperCase();

        main.appendChild(icon);
        main.appendChild(title);

        const actions = document.createElement('div');
        actions.className = 'fonte-actions';

        const btnDesk = document.createElement('button');
        btnDesk.className = 'fonte-btn';
        btnDesk.textContent = '‚ûï Desk';

        const btnDel = document.createElement('button');
        btnDel.className = 'fonte-btn danger';
        btnDel.textContent = '‚úï';

        actions.appendChild(btnDesk);
        actions.appendChild(btnDel);

        row.appendChild(main);
        row.appendChild(actions);
        fontiList.appendChild(row);

        btnDesk.addEventListener('click', () => {
          createCardFromFonte(fonte);
        });

        btnDel.addEventListener('click', () => {
          const idx = fonti.findIndex(f => f.id === fonte.id);
          if (idx !== -1) fonti.splice(idx, 1);
          row.remove();
        });
      }

      /* Strumenti */

      toolText.addEventListener('click', () => {
        createTextCard('Scrivi qui la tua nota‚Ä¶');
      });

      // Immagine
      btnAddImage.addEventListener('click', () => {
        inputImage.value = '';
        inputImage.click();
      });

      inputImage.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          const dataUrl = ev.target.result;
          const id = 'fonte-' + (++fonteIdCounter);
          const fonte = {
            id,
            type: 'image',
            title: file.name,
            shortTitle: file.name.length > 18 ? file.name.slice(0, 16) + '‚Ä¶' : file.name,
            dataUrl
          };
          fonti.push(fonte);
          addFonteToList(fonte);
        };
        reader.readAsDataURL(file);
      });

      // PDF
      btnAddPdf.addEventListener('click', () => {
        inputPdf.value = '';
        inputPdf.click();
      });

      inputPdf.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          const dataUrl = ev.target.result;
          const id = 'fonte-' + (++fonteIdCounter);
          const fonte = {
            id,
            type: 'pdf',
            title: file.name,
            shortTitle: file.name.length > 18 ? file.name.slice(0, 16) + '‚Ä¶' : file.name,
            dataUrl
          };
          fonti.push(fonte);
          addFonteToList(fonte);
        };
        reader.readAsDataURL(file);
      });

      // Pagina web
      btnAddWeb.addEventListener('click', () => {
        const url = window.prompt('Inserisci URL della pagina web:');
        if (!url) return;
        const clean = url.trim();
        const id = 'fonte-' + (++fonteIdCounter);
        const fonte = {
          id,
          type: 'web',
          title: clean,
          shortTitle: clean.length > 22 ? clean.slice(0, 20) + '‚Ä¶' : clean,
          url: clean
        };
        fonti.push(fonte);
        addFonteToList(fonte);
      });

      // Video
      btnAddVideo.addEventListener('click', () => {
        const url = window.prompt('Inserisci URL del video (YouTube, HeyGen, ecc.):');
        if (!url) return;
        const clean = url.trim();
        const id = 'fonte-' + (++fonteIdCounter);
        const fonte = {
          id,
          type: 'video',
          title: clean,
          shortTitle: clean.length > 22 ? clean.slice(0, 20) + '‚Ä¶' : clean,
          url: clean
        };
        fonti.push(fonte);
        addFonteToList(fonte);
      });

      /* Pulizia desk / connettori */

      btnClear.addEventListener('click', () => {
        const cards = canvas.querySelectorAll('.desk-card');
        cards.forEach(c => c.remove());
        clearAllConnectors();
        currentSelectedCard = null;
        connectorStartCard = null;
      });

      btnClearConnectors.addEventListener('click', () => {
        clearAllConnectors();
      });

      // all‚Äôavvio: nessuna card, nessuna fonte ‚Üí desk pulito
    })();
  </script>
</body>
</html>
