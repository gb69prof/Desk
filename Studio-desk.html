<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Interactive Desk â€“ GitHub Pages</title>
  <style>
    :root{
      --bg1:#070b17;
      --bg2:#101727;
      --panel:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.95);
      --muted:rgba(255,255,255,.65);
      --accent:#6ae4ff;
      --danger:#ff5d6a;
      --shadow:0 16px 50px rgba(0,0,0,.55);
      --radius:22px;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    html,body{height:100%;}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(1200px 800px at 10% 0%,#1b2a58 0,transparent 55%),
        radial-gradient(900px 650px at 90% 0%,#1a3b3b 0,transparent 55%),
        linear-gradient(160deg,var(--bg1),var(--bg2));
      color:var(--text);
      overflow:hidden;
    }
    .app{
      height:100%;
      display:grid;
      grid-template-columns:360px 1fr;
      gap:14px;
      padding:14px;
    }
    @media (max-width:900px){
      .app{
        grid-template-columns:1fr;
        grid-template-rows:auto 1fr;
      }
      .left{max-height:48vh;}
    }
    .left,.main{
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));
      box-shadow:var(--shadow);
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--stroke);
      background:linear-gradient(180deg,rgba(0,0,0,.34),rgba(0,0,0,.18));
      flex-shrink:0;
    }
    .brand{display:flex;align-items:center;gap:8px;font-weight:800;letter-spacing:.2px;}
    .dot{
      width:11px;height:11px;border-radius:99px;
      background:radial-gradient(circle at 30% 30%,#fff,var(--accent));
      box-shadow:0 0 0 4px rgba(106,228,255,.18),0 0 24px rgba(106,228,255,.34);
    }
    .sub{font-size:11px;color:var(--muted);font-weight:600;}
    .chip{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      font-size:11px;font-weight:700;
      color:var(--muted);
      white-space:nowrap;
    }
    .chip strong{color:var(--text);}
    .section{
      padding:10px 12px;
      border-bottom:1px solid var(--stroke);
      flex-shrink:0;
    }
    .section h3{font-size:12px;margin-bottom:6px;letter-spacing:.15px;text-transform:uppercase;color:rgba(255,255,255,.82);}
    .row{display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin-top:4px;}
    .input{
      flex:1;min-width:150px;
      padding:8px 10px;
      border-radius:13px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.28);
      color:var(--text);
      font-size:12px;
      outline:none;
    }
    .input::placeholder{color:rgba(255,255,255,.4);}
    .btn{
      appearance:none;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:13px;
      padding:7px 10px;
      font-size:11px;font-weight:750;
      display:inline-flex;align-items:center;gap:6px;
      cursor:pointer;
      transition:background .15s,border-color .15s,transform .05s;
      user-select:none;
    }
    .btn.small{font-size:11px;padding:6px 9px;}
    .btn.primary{border-color:rgba(106,228,255,.5);background:rgba(106,228,255,.18);}
    .btn.danger{border-color:rgba(255,93,106,.55);background:rgba(255,93,106,.16);}
    .btn:hover{background:rgba(255,255,255,.16);}
    .btn:active{transform:translateY(1px) scale(.99);}
    .sources{flex:1 1 auto;min-height:0;overflow:auto;padding:10px 12px 12px 12px;}
    .sourceItem{
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.35);
      border-radius:16px;
      padding:8px;
      display:grid;
      grid-template-columns:52px 1fr;
      gap:8px;
      margin-bottom:8px;
    }
    .thumb{
      width:52px;height:52px;border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.4);
      overflow:hidden;display:flex;align-items:center;justify-content:center;
      font-size:11px;font-weight:800;color:rgba(255,255,255,.7);
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block;}
    .meta{display:flex;flex-direction:column;gap:4px;min-width:0;}
    .meta .title{font-size:12px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .meta .type{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .meta .actions{display:flex;flex-wrap:wrap;gap:6px;}
    .note{font-size:11px;color:var(--muted);line-height:1.35;}

    .main{display:flex;flex-direction:column;min-height:0;}
    .toolbarTop{
      display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;
      padding:8px 10px;
      border-bottom:1px solid var(--stroke);
      background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.2));
      flex-shrink:0;
    }
    .modeGroup{display:flex;flex-wrap:wrap;gap:6px;align-items:center;}
    .btn.toggle{background:rgba(255,255,255,.03);}
    .btn.toggle.active{border-color:rgba(106,228,255,.7);background:rgba(106,228,255,.2);}

    .toolbarHint{
      display:flex;flex-wrap:wrap;gap:6px;align-items:center;
      padding:6px 10px;
      border-bottom:1px solid var(--stroke);
      background:rgba(0,0,0,.24);
      flex-shrink:0;
    }
    .mainBody{flex:1 1 auto;min-height:0;position:relative;overflow:hidden;
      background:
        radial-gradient(circle at 20% 20%,rgba(106,228,255,.12),transparent 50%),
        radial-gradient(circle at 80% 70%,rgba(174,255,186,.12),transparent 52%),
        linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));
    }
    .deskViewport{position:absolute;inset:0;overflow:hidden;touch-action:none;}
    .deskContent{position:absolute;left:0;top:0;transform-origin:0 0;}
    .gridLayer{
      position:absolute;left:0;top:0;width:8000px;height:8000px;
      background-image:
        linear-gradient(to right,rgba(255,255,255,.06) 1px,transparent 1px),
        linear-gradient(to bottom,rgba(255,255,255,.06) 1px,transparent 1px);
      background-size:80px 80px;
      opacity:.25;
      pointer-events:none;
    }
    .gridLayer::after{
      content:"";position:absolute;inset:0;
      background-image:
        linear-gradient(to right,rgba(255,255,255,.08) 1px,transparent 1px),
        linear-gradient(to bottom,rgba(255,255,255,.08) 1px,transparent 1px);
      background-size:16px 16px;
      opacity:.22;
      pointer-events:none;
    }
    .svgLayer{position:absolute;left:0;top:0;width:8000px;height:8000px;pointer-events:none;}

    .card{
      position:absolute;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.22);
      background:linear-gradient(180deg,rgba(0,0,0,.6),rgba(0,0,0,.38));
      box-shadow:0 18px 60px rgba(0,0,0,.7);
      min-width:180px;min-height:120px;
      overflow:hidden;
      touch-action:none;
      user-select:none;
    }
    .card.selected{border-color:rgba(106,228,255,.8);box-shadow:0 22px 70px rgba(0,0,0,.85),0 0 0 3px rgba(106,228,255,.24);}
    .cardHeader{
      height:34px;display:flex;align-items:center;justify-content:space-between;gap:6px;
      padding:6px 8px;
      border-bottom:1px solid rgba(255,255,255,.24);
      background:linear-gradient(90deg,rgba(0,0,0,.72),rgba(0,0,0,.5));
      cursor:grab;
    }
    .cardHeader:active{cursor:grabbing;}
    .badge{font-size:10px;font-weight:800;padding:3px 6px;border-radius:999px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.12);}
    .cardTitle{font-size:11px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px;}
    .cardBtns{display:flex;gap:4px;}
    .iconBtn{
      width:24px;height:24px;border-radius:8px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(255,255,255,.10);
      display:flex;align-items:center;justify-content:center;
      font-size:12px;cursor:pointer;
    }
    .iconBtn.danger{background:rgba(255,93,106,.18);border-color:rgba(255,93,106,.5);}
    .iconBtn:hover{background:rgba(255,255,255,.2);}
    .iconBtn.danger:hover{background:rgba(255,93,106,.28);}
    .cardBody{height:calc(100% - 34px);padding:8px;overflow:hidden;}
    .preview{
      width:100%;height:100%;border-radius:14px;border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.55);
      display:flex;align-items:center;justify-content:center;
      color:rgba(255,255,255,.75);
      font-size:11px;text-align:center;line-height:1.3;
      overflow:hidden;
    }
    .preview img{width:100%;height:100%;object-fit:cover;display:block;}
    .preview .snippet{padding:8px 9px;text-align:left;white-space:pre-wrap;overflow:hidden;display:-webkit-box;-webkit-line-clamp:6;-webkit-box-orient:vertical;font-size:11px;}
    .resizeHandle{
      position:absolute;right:7px;bottom:7px;width:14px;height:14px;border-radius:6px;
      border:1px solid rgba(255,255,255,.35);
      background:rgba(255,255,255,.3);
      cursor:nwse-resize;
    }
    .conn{pointer-events:stroke;cursor:pointer;}

    .toast{
      position:absolute;left:10px;bottom:10px;z-index:50;
      padding:8px 10px;border-radius:13px;
      background:rgba(0,0,0,.7);
      border:1px solid rgba(255,255,255,.2);
      font-size:11px;color:rgba(255,255,255,.9);
      max-width:360px;display:none;
      backdrop-filter:blur(10px);
    }
    .toast.show{display:block;}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;padding:14px;z-index:100;}
    .modal.open{display:flex;}
    .modalBox{
      width:min(1100px,100%);
      height:min(760px,100%);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.22);
      background:linear-gradient(180deg,rgba(0,0,0,.75),rgba(0,0,0,.55));
      box-shadow:var(--shadow);
      display:flex;flex-direction:column;overflow:hidden;
    }
    .modalTop{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.25);background:rgba(0,0,0,.65);}
    .modalTop .title{font-size:13px;font-weight:850;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .modalBody{flex:1 1 auto;min-height:0;overflow:auto;padding:10px;background:rgba(0,0,0,.55);}
    .viewer{border-radius:18px;border:1px solid rgba(255,255,255,.22);overflow:hidden;background:rgba(0,0,0,.8);}
    .viewer iframe,.viewer video{width:100%;height:620px;border:0;display:block;}
    .viewer img{width:100%;height:auto;display:block;}
    .viewer .text{padding:12px 14px;font-size:14px;line-height:1.5;white-space:pre-wrap;}

    .pdfEmbed{width:100%;height:620px;border:0;display:block;background:#000;}
    input[type="file"]{display:none;}
  </style>
</head>
<body>
  <div class="app">
    <aside class="left">
      <div class="topbar">
        <div>
          <div class="brand"><span class="dot"></span>Interactive Desk</div>
          <div class="sub">GitHub Pages Â· static</div>
        </div>
        <div class="chip">Card: <strong id="cardCount">0</strong></div>
      </div>
      <div class="section">
        <h3>Aggiungi contenuti (creano SUBITO una card)</h3>
        <div class="row">
          <label class="btn small primary" for="imgFile">+ Immagine</label>
          <input id="imgFile" type="file" accept="image/*" />
          <label class="btn small primary" for="pdfFile">+ PDF</label>
          <input id="pdfFile" type="file" accept="application/pdf" />
        </div>
        <div class="row">
          <input id="webUrl" class="input" placeholder="URL pagina web" />
          <button class="btn small primary" id="addWebBtn">+ Web</button>
        </div>
        <div class="row">
          <input id="videoUrl" class="input" placeholder="URL video (YouTube o mp4)" />
          <button class="btn small primary" id="addVideoBtn">+ Video</button>
        </div>
        <div class="row">
          <input id="textTitle" class="input" placeholder="Titolo testo" />
          <button class="btn small primary" id="addTextBtn">+ Testo</button>
        </div>
        <div class="row"><div class="note">Ogni volta che aggiungi una fonte: appare una card sul desk e la fonte entra nel deposito qui sotto.</div></div>
      </div>
      <div class="section">
        <h3>Desk & salvataggio</h3>
        <div class="row">
          <button class="btn small" id="exportBtn">Esporta JSON</button>
          <label class="btn small" for="importFile">Importa JSON</label>
          <input id="importFile" type="file" accept="application/json" />
        </div>
        <div class="row">
          <button class="btn small danger" id="clearDeskBtn">Svuota desk</button>
          <button class="btn small danger" id="clearSourcesBtn">Svuota fonti</button>
        </div>
      </div>
      <div class="section">
        <h3>Deposito fonti</h3>
        <div class="note">Da qui puoi creare altre card o cancellare la fonte. All'avvio Ã¨ SEMPRE vuoto.</div>
      </div>
      <div class="sources" id="sourcesList"></div>
    </aside>

    <main class="main">
      <div class="toolbarTop">
        <div class="modeGroup">
          <span class="chip">ModalitÃ </span>
          <button class="btn small toggle active" id="modeMove">Muovi</button>
          <button class="btn small toggle" id="modePan">Pan</button>
          <button class="btn small toggle" id="modeConnect">Connetti</button>
          <button class="btn small toggle" id="modeDelete">Cancella</button>
        </div>
        <div class="modeGroup">
          <span class="chip">Zoom: <strong id="zoomLabel">100%</strong></span>
          <span class="chip">Connettori
            <input id="connColor" type="color" value="#6ae4ff" style="width:40px;height:24px;border:none;background:transparent;">
          </span>
          <button class="btn small" id="resetViewBtn">Reset vista</button>
          <button class="btn small danger" id="clearConnBtn">Cancella connettori</button>
        </div>
      </div>
      <div class="toolbarHint">
        <span class="chip">Header card: <strong>trascina per muovere</strong></span>
        <span class="chip">Angolo: <strong>trascina per ridimensionare</strong></span>
        <span class="chip">Tocco card: <strong>apri contenuto</strong></span>
        <span class="chip">Connetti: <strong>toca due card</strong></span>
      </div>
      <div class="mainBody">
        <div class="deskViewport" id="deskViewport">
          <div class="deskContent" id="deskContent">
            <div class="gridLayer"></div>
            <svg class="svgLayer" id="svgLayer" xmlns="http://www.w3.org/2000/svg"></svg>
          </div>
          <div class="toast" id="toast"></div>
        </div>
      </div>
    </main>
  </div>

  <div class="modal" id="modal">
    <div class="modalBox">
      <div class="modalTop">
        <div class="title" id="modalTitle">Viewer</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          <button class="btn small" id="openNewTabBtn" style="display:none;">Apri in nuova scheda</button>
          <button class="btn small danger" id="closeModalBtn">Chiudi</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="viewer" id="viewer"></div>
      </div>
    </div>
  </div>

  <script>
    const $ = (s,el=document)=>el.querySelector(s);
    const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));
    const uid = ()=>Math.random().toString(16).slice(2)+Date.now().toString(16);
    const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

    const deskViewport = document.getElementById("deskViewport");
    const deskContent  = document.getElementById("deskContent");
    const svgLayer     = document.getElementById("svgLayer");
    const sourcesList  = document.getElementById("sourcesList");
    const toast        = document.getElementById("toast");

    const modal        = document.getElementById("modal");
    const viewer       = document.getElementById("viewer");
    const modalTitle   = document.getElementById("modalTitle");
    const openNewTabBtn= document.getElementById("openNewTabBtn");

    const state = {
      view:{scale:1,tx:60,ty:60},
      mode:"move", // move | pan | connect | delete
      cards:[],
      connectors:[],
      sources:[],
      selectedCardId:null,
      connectingFrom:null,
      drag:null,
      panStart:null,
      activePointerId:null
    };

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(showToast._tm);
      showToast._tm = setTimeout(()=>toast.classList.remove("show"),2200);
    }

    function updateZoomLabel(){
      document.getElementById("zoomLabel").textContent = Math.round(state.view.scale*100)+"%";
    }

    function applyTransform(){
      const v = state.view;
      deskContent.style.transform = `translate(${v.tx}px,${v.ty}px) scale(${v.scale})`;
      updateZoomLabel();
    }

    function resetView(){
      state.view.scale = 1;
      state.view.tx = 60;
      state.view.ty = 60;
      applyTransform();
    }

    function updateCardCount(){
      document.getElementById("cardCount").textContent = state.cards.length;
    }

    function setMode(mode){
      state.mode = mode;
      state.connectingFrom = null;
      ["modeMove","modePan","modeConnect","modeDelete"].forEach(id=>{
        document.getElementById(id).classList.remove("active");
      });
      if(mode==="move") document.getElementById("modeMove").classList.add("active");
      if(mode==="pan") document.getElementById("modePan").classList.add("active");
      if(mode==="connect") document.getElementById("modeConnect").classList.add("active");
      if(mode==="delete") document.getElementById("modeDelete").classList.add("active");
      if(mode==="connect") showToast("Connetti: tocca due card.");
      else if(mode==="delete") showToast("Cancella: tocca card o linea.");
      else if(mode==="pan") showToast("Pan: trascina lo sfondo per muovere.");
    }

    function renderSources(){
      sourcesList.innerHTML="";
      if(state.sources.length===0){
        const d=document.createElement("div");
        d.className="note";
        d.style.padding="8px 2px";
        d.textContent="Nessuna fonte caricata. Usa i pulsanti sopra per aggiungere immagini, PDF, web, video o testo.";
        sourcesList.appendChild(d);
        return;
      }
      for(const s of state.sources){
        const wrap=document.createElement("div");
        wrap.className="sourceItem";
        wrap.dataset.id=s.id;
        const t=document.createElement("div");
        t.className="thumb";
        if(s.type==="image" && s.dataUrl){
          const img=new Image();img.src=s.dataUrl;t.appendChild(img);
        }else{
          t.textContent=s.type.toUpperCase();
        }
        const meta=document.createElement("div");
        meta.className="meta";
        const title=document.createElement("div");
        title.className="title";
        title.textContent=s.title||"Senza titolo";
        const type=document.createElement("div");
        type.className="type";
        type.textContent=s.desc||s.type;
        const act=document.createElement("div");
        act.className="actions";

        const addBtn=document.createElement("button");
        addBtn.className="btn small";
        addBtn.textContent="Nuova card";
        addBtn.onclick=()=>addCardFromSource(s.id);

        const delBtn=document.createElement("button");
        delBtn.className="btn small danger";
        delBtn.textContent="Cancella fonte";
        delBtn.onclick=()=>{
          const idx=state.sources.findIndex(x=>x.id===s.id);
          if(idx>=0) state.sources.splice(idx,1);
          renderSources();
        };

        act.appendChild(addBtn);
        act.appendChild(delBtn);
        meta.appendChild(title);
        meta.appendChild(type);
        meta.appendChild(act);
        wrap.appendChild(t);
        wrap.appendChild(meta);
        sourcesList.appendChild(wrap);
      }
    }

    function renderCards(){
      $$(".card",deskContent).forEach(el=>el.remove());
      for(const c of state.cards){
        const el=document.createElement("div");
        el.className="card";
        if(state.selectedCardId===c.id) el.classList.add("selected");
        el.style.left=c.x+"px";
        el.style.top=c.y+"px";
        el.style.width=c.w+"px";
        el.style.height=c.h+"px";
        el.dataset.id=c.id;

        const header=document.createElement("div");
        header.className="cardHeader";
        const left=document.createElement("div");
        left.style.display="flex";
        left.style.alignItems="center";
        left.style.gap="6px";
        left.style.minWidth="0";
        const badge=document.createElement("div");
        badge.className="badge";
        badge.textContent=c.type;
        const title=document.createElement("div");
        title.className="cardTitle";
        title.textContent=c.title||c.type.toUpperCase();
        left.appendChild(badge);left.appendChild(title);

        const btns=document.createElement("div");
        btns.className="cardBtns";
        const openBtn=document.createElement("div");
        openBtn.className="iconBtn";
        openBtn.textContent="â†—";
        openBtn.title="Apri";
        openBtn.onclick=e=>{e.stopPropagation();openCard(c.id);};
        const delBtn=document.createElement("div");
        delBtn.className="iconBtn danger";
        delBtn.textContent="Ã—";
        delBtn.title="Elimina card";
        delBtn.onclick=e=>{e.stopPropagation();deleteCard(c.id);};
        btns.appendChild(openBtn);btns.appendChild(delBtn);
        header.appendChild(left);header.appendChild(btns);

        const body=document.createElement("div");
        body.className="cardBody";
        const prev=document.createElement("div");
        prev.className="preview";
        if(c.type==="image" && c.dataUrl){
          const img=new Image();img.src=c.dataUrl;prev.appendChild(img);
        }else if(c.type==="text"){
          const sn=document.createElement("div");
          sn.className="snippet";
          sn.textContent=c.text||"";
          prev.appendChild(sn);
        }else if(c.type==="pdf"){
          prev.textContent="PDF â€“ tocca per aprire";
        }else if(c.type==="web"){
          prev.textContent="ðŸŒ Pagina web â€“ tocca per aprire";
        }else if(c.type==="video"){
          prev.textContent="â–¶ Video â€“ tocca per aprire";
        }else{
          prev.textContent="Contenuto";
        }
        body.appendChild(prev);

        const handle=document.createElement("div");
        handle.className="resizeHandle";

        el.appendChild(header);
        el.appendChild(body);
        el.appendChild(handle);

        // TAP / CLICK card
        el.addEventListener("click",e=>{
          if(e.defaultPrevented) return;
          if(state.mode==="delete"){deleteCard(c.id);return;}
          if(state.mode==="connect"){handleConnectTap(c.id);return;}
          openCard(c.id);
        });

        // DRAG move / resize (iPad friendly: niente pointer capture)
        header.addEventListener("pointerdown",e=>startCardDrag(e,c.id,"move"));
        handle.addEventListener("pointerdown",e=>startCardDrag(e,c.id,"resize"));

        deskContent.appendChild(el);
      }
      updateCardCount();
      renderConnectors();
    }

    function renderConnectors(){
      svgLayer.innerHTML="";
      svgLayer.setAttribute("viewBox","0 0 8000 8000");
      for(const cn of state.connectors){
        const a=state.cards.find(x=>x.id===cn.a);
        const b=state.cards.find(x=>x.id===cn.b);
        if(!a||!b) continue;
        const ax=a.x+a.w/2, ay=a.y+a.h/2;
        const bx=b.x+b.w/2, by=b.y+b.h/2;
        const dx=Math.abs(bx-ax);
        const c1x=ax+(bx>ax?dx*0.35:-dx*0.35);
        const c1y=ay;
        const c2x=bx-(bx>ax?dx*0.35:-dx*0.35);
        const c2y=by;
        const d=`M ${ax} ${ay} C ${c1x} ${c1y}, ${c2x} ${c2y}, ${bx} ${by}`;
        const glow=document.createElementNS("http://www.w3.org/2000/svg","path");
        glow.setAttribute("d",d);
        glow.setAttribute("fill","none");
        glow.setAttribute("stroke",cn.color||"#6ae4ff");
        glow.setAttribute("stroke-width","14");
        glow.setAttribute("stroke-linecap","round");
        glow.setAttribute("opacity","0.12");
        glow.style.pointerEvents="none";
        const path=document.createElementNS("http://www.w3.org/2000/svg","path");
        path.setAttribute("d",d);
        path.setAttribute("fill","none");
        path.setAttribute("stroke",cn.color||"#6ae4ff");
        path.setAttribute("stroke-width","5");
        path.setAttribute("stroke-linecap","round");
        path.setAttribute("opacity","0.95");
        path.classList.add("conn");
        path.style.pointerEvents="stroke";
        path.addEventListener("click",e=>{
          e.stopPropagation();
          if(state.mode==="delete"){
            const idx=state.connectors.findIndex(x=>x.id===cn.id);
            if(idx>=0) state.connectors.splice(idx,1);
            renderConnectors();
          }else{
            showToast("Linea selezionata: passa a 'Cancella' per rimuoverla.");
          }
        });
        svgLayer.appendChild(glow);
        svgLayer.appendChild(path);
      }
    }

    function deleteCard(cardId){
      state.connectors=state.connectors.filter(cn=>cn.a!==cardId && cn.b!==cardId);
      state.cards=state.cards.filter(c=>c.id!==cardId);
      if(state.selectedCardId===cardId) state.selectedCardId=null;
      renderCards();
      showToast("Card eliminata.");
    }

    function handleConnectTap(cardId){
      if(!state.connectingFrom){
        state.connectingFrom=cardId;
        state.selectedCardId=cardId;
        $$(".card",deskContent).forEach(el=>{
          el.classList.toggle("selected",el.dataset.id===cardId);
        });
        showToast("Ora tocca un'altra card per completare il connettore.");
        return;
      }
      if(state.connectingFrom===cardId){
        state.connectingFrom=null;
        showToast("Connessione annullata.");
        return;
      }
      const exists=state.connectors.some(cn=>(cn.a===state.connectingFrom&&cn.b===cardId)||(cn.a===cardId&&cn.b===state.connectingFrom));
      if(exists){showToast("Connettore giÃ  presente.");state.connectingFrom=null;return;}
      state.connectors.push({id:uid(),a:state.connectingFrom,b:cardId,color:document.getElementById("connColor").value});
      state.connectingFrom=null;
      renderConnectors();
      showToast("Connettore creato.");
    }

    function clearDesk(){
      state.cards=[];
      state.connectors=[];
      state.selectedCardId=null;
      renderCards();
      showToast("Desk svuotato.");
    }

    function clearSources(){
      state.sources=[];
      renderSources();
      showToast("Fonti svuotate.");
    }

    function startCardDrag(e,cardId,kind){
      if(state.mode!=="move") return;
      e.preventDefault();
      e.stopPropagation();
      const card=state.cards.find(c=>c.id===cardId);
      if(!card) return;
      state.selectedCardId=cardId;
      $$(".card",deskContent).forEach(el=>{
        el.classList.toggle("selected",el.dataset.id===cardId);
      });
      state.activePointerId=e.pointerId;
      state.drag={
        cardId,
        kind,
        startX:card.x,
        startY:card.y,
        startW:card.w,
        startH:card.h,
        startClientX:e.clientX,
        startClientY:e.clientY
      };
      window.addEventListener("pointermove",onCardDragMove,{passive:false});
      window.addEventListener("pointerup",onCardDragEnd,{passive:false});
      window.addEventListener("pointercancel",onCardDragEnd,{passive:false});
    }

    function onCardDragMove(e){
      if(!state.drag || e.pointerId!==state.activePointerId) return;
      e.preventDefault();
      const d=state.drag;
      const card=state.cards.find(c=>c.id===d.cardId);
      if(!card) return;
      const dxScreen=e.clientX-d.startClientX;
      const dyScreen=e.clientY-d.startClientY;
      const dxDesk=dxScreen/state.view.scale;
      const dyDesk=dyScreen/state.view.scale;
      if(d.kind==="move"){
        card.x=clamp(d.startX+dxDesk,0,8000-100);
        card.y=clamp(d.startY+dyDesk,0,8000-80);
      }else{
        card.w=clamp(d.startW+dxDesk,180,900);
        card.h=clamp(d.startH+dyDesk,120,780);
      }
      const el=$(`.card[data-id="${card.id}"]`,deskContent);
      if(el){
        el.style.left=card.x+"px";
        el.style.top=card.y+"px";
        el.style.width=card.w+"px";
        el.style.height=card.h+"px";
      }
      renderConnectors();
    }

    function onCardDragEnd(e){
      if(!state.drag || e.pointerId!==state.activePointerId) return;
      state.drag=null;
      state.activePointerId=null;
      window.removeEventListener("pointermove",onCardDragMove);
      window.removeEventListener("pointerup",onCardDragEnd);
      window.removeEventListener("pointercancel",onCardDragEnd);
    }

    // Pan & zoom desk
    deskViewport.addEventListener("pointerdown",e=>{
      if(state.mode!=="pan") return;
      if(e.target.closest(".card")) return;
      e.preventDefault();
      state.activePointerId=e.pointerId;
      state.panStart={
        startTx:state.view.tx,
        startTy:state.view.ty,
        startX:e.clientX,
        startY:e.clientY
      };
      window.addEventListener("pointermove",onPanMove,{passive:false});
      window.addEventListener("pointerup",onPanEnd,{passive:false});
      window.addEventListener("pointercancel",onPanEnd,{passive:false});
    });

    function onPanMove(e){
      if(!state.panStart || e.pointerId!==state.activePointerId) return;
      e.preventDefault();
      const p=state.panStart;
      state.view.tx=p.startTx+(e.clientX-p.startX);
      state.view.ty=p.startTy+(e.clientY-p.startY);
      applyTransform();
    }

    function onPanEnd(e){
      if(e.pointerId!==state.activePointerId) return;
      state.panStart=null;
      state.activePointerId=null;
      window.removeEventListener("pointermove",onPanMove);
      window.removeEventListener("pointerup",onPanEnd);
      window.removeEventListener("pointercancel",onPanEnd);
    }

    deskViewport.addEventListener("wheel",e=>{
      e.preventDefault();
      const delta=-e.deltaY;
      const factor=delta>0?1.08:0.92;
      const rect=deskViewport.getBoundingClientRect();
      const x=e.clientX-rect.left;
      const y=e.clientY-rect.top;
      const beforeX=(x-state.view.tx)/state.view.scale;
      const beforeY=(y-state.view.ty)/state.view.scale;
      state.view.scale=clamp(state.view.scale*factor,0.4,2.5);
      state.view.tx=x-beforeX*state.view.scale;
      state.view.ty=y-beforeY*state.view.scale;
      applyTransform();
    },{passive:false});

    deskViewport.addEventListener("click",e=>{
      if(e.target.closest(".card")) return;
      if(state.mode==="connect" && state.connectingFrom){
        state.connectingFrom=null;
        showToast("Connessione annullata.");
      }
      state.selectedCardId=null;
      $$(".card",deskContent).forEach(el=>el.classList.remove("selected"));
    });

    // Viewer
    function dataUrlFromPdfBase64(b64){
      return "data:application/pdf;base64,"+b64;
    }

    function openCard(cardId){
      const c=state.cards.find(x=>x.id===cardId);
      if(!c) return;
      modalTitle.textContent=c.title||c.type.toUpperCase();
      viewer.innerHTML="";
      openNewTabBtn.style.display="none";
      openNewTabBtn.onclick=null;

      if(c.type==="image" && c.dataUrl){
        const img=new Image();img.src=c.dataUrl;viewer.appendChild(img);
      }else if(c.type==="text"){
        const d=document.createElement("div");
        d.className="text";d.textContent=c.text||"";viewer.appendChild(d);
      }else if(c.type==="web"){
        const iframe=document.createElement("iframe");
        iframe.src=c.url;
        iframe.referrerPolicy="no-referrer";
        iframe.allow="accelerometer; autoplay; encrypted-media; fullscreen";
        viewer.appendChild(iframe);
        openNewTabBtn.style.display="inline-flex";
        openNewTabBtn.onclick=()=>window.open(c.url,"_blank","noopener,noreferrer");
      }else if(c.type==="video"){
        const url=c.url;
        const yt=toYouTubeEmbed(url);
        if(yt){
          const iframe=document.createElement("iframe");
          iframe.src=yt;
          iframe.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
          iframe.allowFullscreen=true;
          viewer.appendChild(iframe);
        }else if(/\.mp4(\?.*)?$/i.test(url)){
          const v=document.createElement("video");
          v.src=url;v.controls=true;v.playsInline=true;viewer.appendChild(v);
        }else{
          const iframe=document.createElement("iframe");
          iframe.src=url;iframe.allow="autoplay; encrypted-media; fullscreen";viewer.appendChild(iframe);
        }
        openNewTabBtn.style.display="inline-flex";
        openNewTabBtn.onclick=()=>window.open(url,"_blank","noopener,noreferrer");
      }else if(c.type==="pdf"){
        const info=document.createElement("div");
        info.className="note";
        info.style.padding="8px 10px";
        info.textContent="PDF: se l'anteprima non si carica, usa 'Apri in nuova scheda'.";
        viewer.appendChild(info);
        if(c.pdfBase64){
          const embed=document.createElement("embed");
          embed.className="pdfEmbed";
          embed.type="application/pdf";
          embed.src=dataUrlFromPdfBase64(c.pdfBase64);
          viewer.appendChild(embed);
        }
        openNewTabBtn.style.display="inline-flex";
        openNewTabBtn.onclick=()=>{
          if(!c.pdfBase64) return;
          const url=dataUrlFromPdfBase64(c.pdfBase64);
          window.open(url,"_blank","noopener,noreferrer");
        };
      }else{
        const d=document.createElement("div");d.className="text";d.textContent="Contenuto non riconosciuto";viewer.appendChild(d);
      }
      modal.classList.add("open");
    }

    document.getElementById("closeModalBtn").onclick=()=>modal.classList.remove("open");
    modal.addEventListener("click",e=>{if(e.target===modal)modal.classList.remove("open");});

    function toYouTubeEmbed(url){
      try{
        const u=new URL(url);
        if(u.hostname.includes("youtu.be")){
          const id=u.pathname.slice(1);
          if(id) return "https://www.youtube.com/embed/"+id;
        }
        if(u.hostname.includes("youtube.com")){
          const v=u.searchParams.get("v");
          if(v) return "https://www.youtube.com/embed/"+v;
          if(u.pathname.startsWith("/shorts/")){
            const id=u.pathname.split("/shorts/")[1].split(/[/?#]/)[0];
            if(id) return "https://www.youtube.com/embed/"+id;
          }
        }
      }catch(e){}
      return null;
    }

    async function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const r=new FileReader();
        r.onload=()=>resolve(r.result);
        r.onerror=reject;
        r.readAsDataURL(file);
      });
    }

    async function fileToBase64Raw(file){
      return new Promise((resolve,reject)=>{
        const r=new FileReader();
        r.onload=()=>{
          const arr=new Uint8Array(r.result);
          let bin="";for(let i=0;i<arr.length;i++)bin+=String.fromCharCode(arr[i]);
          resolve(btoa(bin));
        };
        r.onerror=reject;
        r.readAsArrayBuffer(file);
      });
    }

    function addSourceAndCard(source){
      state.sources.unshift(source);
      renderSources();
      addCardFromSource(source.id);
    }

    function addCardFromSource(sourceId){
      const s=state.sources.find(x=>x.id===sourceId);
      if(!s) return;
      const rect=deskViewport.getBoundingClientRect();
      const cx=(rect.left+rect.right)/2;
      const cy=(rect.top+rect.bottom)/2;
      const deskX=(cx-state.view.tx)/state.view.scale;
      const deskY=(cy-state.view.ty)/state.view.scale;
      const card={
        id:uid(),
        type:s.type,
        title:s.title||s.type.toUpperCase(),
        x:deskX-190,
        y:deskY-120,
        w:(s.type==="text"?340:360),
        h:(s.type==="image"?260:(s.type==="pdf"?280:240))
      };
      if(s.type==="image") card.dataUrl=s.dataUrl;
      if(s.type==="text") card.text=s.text||"";
      if(s.type==="web") card.url=s.url;
      if(s.type==="video") card.url=s.url;
      if(s.type==="pdf") card.pdfBase64=s.pdfBase64;
      state.cards.push(card);
      state.selectedCardId=card.id;
      renderCards();
      showToast("Card creata sul desk.");
    }

    // Input handlers
    document.getElementById("imgFile").addEventListener("change",async e=>{
      const file=e.target.files && e.target.files[0];
      e.target.value="";
      if(!file) return;
      const dataUrl=await fileToBase64(file);
      const src={id:uid(),type:"image",title:file.name,desc:"Immagine",dataUrl};
      addSourceAndCard(src);
    });

    document.getElementById("pdfFile").addEventListener("change",async e=>{
      const file=e.target.files && e.target.files[0];
      e.target.value="";
      if(!file) return;
      const b64=await fileToBase64Raw(file);
      const src={id:uid(),type:"pdf",title:file.name,desc:"PDF",pdfBase64:b64};
      addSourceAndCard(src);
    });

    document.getElementById("addWebBtn").addEventListener("click",()=>{
      let url=document.getElementById("webUrl").value.trim();
      if(!url){showToast("Inserisci un URL.");return;}
      if(!/^https?:\/\//i.test(url)) url="https://"+url;
      const src={id:uid(),type:"web",title:"Web",desc:url,url};
      document.getElementById("webUrl").value="";
      addSourceAndCard(src);
    });

    document.getElementById("addVideoBtn").addEventListener("click",()=>{
      let url=document.getElementById("videoUrl").value.trim();
      if(!url){showToast("Inserisci un URL video.");return;}
      if(!/^https?:\/\//i.test(url)) url="https://"+url;
      const src={id:uid(),type:"video",title:"Video",desc:url,url};
      document.getElementById("videoUrl").value="";
      addSourceAndCard(src);
    });

    document.getElementById("addTextBtn").addEventListener("click",()=>{
      const t=document.getElementById("textTitle").value.trim()||"Testo";
      const txt=window.prompt("Inserisci o incolla il testo della card:");
      if(txt===null) return;
      const src={id:uid(),type:"text",title:t,desc:"Testo",text:txt};
      document.getElementById("textTitle").value="";
      addSourceAndCard(src);
    });

    // Export / import JSON
    function downloadJson(filename,data){
      const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download=filename;
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(a.href);
      a.remove();
    }

    document.getElementById("exportBtn").addEventListener("click",()=>{
      const payload={
        version:1,
        exportedAt:new Date().toISOString(),
        cards:state.cards,
        connectors:state.connectors,
        view:state.view
      };
      downloadJson("desk-export-"+Date.now()+".json",payload);
      showToast("Export JSON creato.");
    });

    document.getElementById("importFile").addEventListener("change",async e=>{
      const file=e.target.files && e.target.files[0];
      e.target.value="";
      if(!file) return;
      try{
        const text=await file.text();
        const payload=JSON.parse(text);
        if(!payload || !Array.isArray(payload.cards)) throw new Error("Formato non valido");
        state.cards=payload.cards;
        state.connectors=payload.connectors||[];
        state.view=payload.view||state.view;
        state.selectedCardId=null;
        renderCards();
        applyTransform();
        showToast("Desk importato.");
      }catch(err){
        console.error(err);
        showToast("Import fallito (file non valido).");
      }
    });

    // Buttons
    document.getElementById("clearDeskBtn").addEventListener("click",()=>{
      if(confirm("Vuoi svuotare il desk?")) clearDesk();
    });
    document.getElementById("clearSourcesBtn").addEventListener("click",()=>{
      if(confirm("Vuoi svuotare il deposito fonti?")) clearSources();
    });
    document.getElementById("clearConnBtn").addEventListener("click",()=>{
      if(confirm("Vuoi cancellare tutti i connettori?")){
        state.connectors=[];renderConnectors();showToast("Connettori cancellati.");
      }
    });
    document.getElementById("resetViewBtn").addEventListener("click",resetView);

    document.getElementById("modeMove").addEventListener("click",()=>setMode("move"));
    document.getElementById("modePan").addEventListener("click",()=>setMode("pan"));
    document.getElementById("modeConnect").addEventListener("click",()=>setMode("connect"));
    document.getElementById("modeDelete").addEventListener("click",()=>setMode("delete"));

    // Self-test minimi
    (function selfTests(){
      try{
        console.assert(typeof uid()==="string","uid dovrebbe restituire una stringa");
        console.assert(toYouTubeEmbed("https://youtu.be/dQw4w9WgXcQ"),"YouTube short link da riconoscere");
      }catch(e){console.warn("Self test fallito",e);}
    })();

    // Init
    resetView();
    renderSources();
    renderCards();
    showToast("Desk pronto: aggiungi una fonte, la card appare sul desk e nel deposito.");
  </script>
</body>
</html>
