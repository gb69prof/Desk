<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Desk interattivo iPad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg-app: #f4f5f7;
      --bg-canvas: #f9fafb;
      --card-bg: #ffffff;
      --accent: #3b82f6;
      --accent-soft: rgba(59, 130, 246, 0.08);
      --border-subtle: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --shadow-soft: 0 12px 30px rgba(15, 23, 42, 0.12);
      --radius-card: 20px;
      --radius-pill: 999px;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: var(--bg-app);
      -webkit-user-select: none;
      user-select: none;
      touch-action: none; /* blocco lo scroll mentre trasciniamo sul canvas */
    }

    body {
      display: flex;
      flex-direction: column;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    .topbar {
      height: 52px;
      padding: 0 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(to right, #f9fafb, #e5e7eb);
      border-bottom: 1px solid rgba(148,163,184,0.5);
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .app-logo {
      width: 24px;
      height: 24px;
      border-radius: 10px;
      background: radial-gradient(circle at 0 0, #a855f7, #3b82f6);
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.25);
    }

    .app-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #0f172a;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pill-button {
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: #ffffff;
      padding: 5px 12px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      color: var(--text-muted);
      transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.08s ease;
    }

    .pill-button:hover {
      background: #f3f4f6;
      box-shadow: 0 4px 10px rgba(148, 163, 184, 0.3);
      transform: translateY(-1px);
    }

    .pill-button span.icon {
      font-size: 14px;
      line-height: 1;
    }

    .main {
      flex: 1;
      display: flex;
      padding: 8px;
      gap: 8px;
      overflow: hidden;
    }

    .sidebar {
      width: 240px;
      min-width: 220px;
      background: #f9fafb;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .sidebar-title {
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #6b7280;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sidebar-title span.badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(59,130,246,0.08);
      color: #1d4ed8;
      border: 1px solid rgba(59,130,246,0.25);
    }

    .tool-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .tool-button {
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: #ffffff;
      box-shadow: 0 3px 9px rgba(15, 23, 42, 0.06);
      padding: 6px 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: background 0.12s ease, transform 0.08s ease, box-shadow 0.12s ease;
    }

    .tool-button:active {
      transform: scale(0.98);
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.18);
    }

    .tool-main {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tool-icon {
      width: 24px;
      height: 24px;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .tool-icon.text {
      background: rgba(59,130,246,0.12);
      color: #1d4ed8;
    }

    .tool-text-title {
      font-size: 13px;
      font-weight: 600;
    }

    .tool-text-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .tool-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px dashed rgba(148, 163, 184, 0.8);
      color: #6b7280;
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 11px;
      color: var(--text-muted);
      border-top: 1px dashed rgba(148, 163, 184, 0.6);
      padding-top: 6px;
    }

    .canvas {
      flex: 1;
      position: relative;
      border-radius: 20px;
      background:
        radial-gradient(circle at 0 0, rgba(129, 140, 248, 0.18), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(45, 212, 191, 0.18), transparent 55%),
        var(--bg-canvas);
      border: 1px solid rgba(148,163,184,0.4);
      box-shadow: 0 16px 36px rgba(15, 23, 42, 0.2);
      overflow: hidden;
    }

    .canvas-grid {
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(to right, rgba(148,163,184,0.16) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(148,163,184,0.12) 1px, transparent 1px);
      background-size: 32px 32px;
      opacity: 0.35;
      pointer-events: none;
    }

    .connector-layer {
      position: absolute;
      inset: 0;
      pointer-events: auto;
      z-index: 1;
    }

    .connector-path {
      fill: none;
      stroke: rgba(15,23,42,0.5);
      stroke-width: 2;
      stroke-linecap: round;
      cursor: pointer;
      transition: stroke 0.12s ease, stroke-width 0.12s ease;
    }

    .connector-path.selected {
      stroke: var(--accent);
      stroke-width: 3;
    }

    .desk-card {
      position: absolute;
      min-width: 220px;
      min-height: 140px;
      max-width: 620px;
      background: var(--card-bg);
      border-radius: var(--radius-card);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid rgba(148,163,184,0.35);
      transition: box-shadow 0.12s ease, transform 0.08s ease, border-color 0.12s ease;
      z-index: 2;
    }

    .desk-card.selected {
      border-color: var(--accent);
      box-shadow: 0 16px 40px rgba(59,130,246,0.32);
      transform: translateY(-1px);
    }

    .card-header {
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 8px 0 10px;
      background: linear-gradient(to right, rgba(15,23,42,0.04), rgba(148,163,184,0.04));
      border-bottom: 1px solid rgba(148,163,184,0.35);
      position: relative;
      z-index: 3;
    }

    .card-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      overflow: hidden;
    }

    .card-type-icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      background: rgba(59,130,246,0.15);
      color: #1d4ed8;
    }

    .card-title {
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 140px;
    }

    .card-header-actions {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .icon-button {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 13px;
      color: #6b7280;
      transition: background 0.12s ease, color 0.12s ease, transform 0.08s ease;
    }

    .icon-button:active {
      transform: scale(0.9);
      background: rgba(148,163,184,0.3);
    }

    .icon-button.danger:active {
      background: rgba(248,113,113,0.2);
      color: #b91c1c;
    }

    .card-body {
      flex: 1;
      padding: 8px 10px 8px 10px;
      overflow: hidden;
      display: flex;
      align-items: stretch;
      justify-content: stretch;
      position: relative;
      z-index: 2;
    }

    .card-body-inner {
      width: 100%;
      height: 100%;
      overflow: auto;
      border-radius: 12px;
      background: #f9fafb;
      padding: 4px;
    }

    .card-text-content {
      width: 100%;
      min-height: 80px;
      font-size: 13px;
      line-height: 1.5;
      outline: none;
      border-radius: 10px;
      border: 1px solid rgba(209,213,219,0.8);
      padding: 6px 6px 10px 6px;
      background: #ffffff;
      -webkit-user-select: text;
      user-select: text;
      touch-action: auto;
    }

    .resize-handle {
      position: absolute;
      width: 16px;
      height: 16px;
      right: 6px;
      bottom: 6px;
      border-radius: 4px;
      background: rgba(15,23,42,0.06);
      border: 1px solid rgba(148,163,184,0.9);
      cursor: se-resize;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #6b7280;
      z-index: 4;
    }

    .resize-handle::before {
      content: "";
      width: 8px;
      height: 8px;
      border-right: 1px solid rgba(107,114,128,0.9);
      border-bottom: 1px solid rgba(107,114,128,0.9);
      transform: translate(1px, 1px);
    }

    .connector-handle {
      position: absolute;
      width: 12px;
      height: 12px;
      right: -6px;
      top: 50%;
      transform: translateY(-50%);
      border-radius: 999px;
      background: var(--accent-soft);
      border: 1px solid rgba(59,130,246,0.7);
      cursor: crosshair;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
      box-shadow: 0 0 0 2px rgba(248,250,252,0.9);
    }

    .connector-handle::before {
      content: "";
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: #3b82f6;
    }

    .desk-card.collapsed {
      height: 40px !important;
    }
    .desk-card.collapsed .card-body { display: none; }
    .desk-card.collapsed .resize-handle { display: none; }

    @media (max-width: 900px) {
      .sidebar { display: none; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="topbar-left">
        <div class="app-logo"></div>
        <div class="app-title">Desk interattivo</div>
      </div>
      <div class="topbar-right">
        <button class="pill-button" id="btn-clear">
          <span class="icon">ðŸ§¹</span><span>Nuovo desk</span>
        </button>
      </div>
    </header>

    <main class="main">
      <aside class="sidebar">
        <div class="sidebar-title">
          Strumenti
          <span class="badge">Desk</span>
        </div>
        <div class="tool-list">
          <button class="tool-button" id="tool-text">
            <div class="tool-main">
              <div class="tool-icon text">T</div>
              <div>
                <div class="tool-text-title">Nota di testo</div>
                <div class="tool-text-sub">Appunti, idee, schemi</div>
              </div>
            </div>
            <div class="tool-badge">TXT</div>
          </button>
        </div>
        <div class="sidebar-footer">
          âžœ Trascina la barra per muovere le card.<br>
          âžœ Trascina lâ€™angolo in basso per ridimensionare.<br>
          âžœ Tocca il pallino blu per creare connettori.<br>
          âžœ Tocca una linea per eliminarla.
        </div>
      </aside>

      <section class="canvas" id="canvas">
        <svg id="connector-layer" class="connector-layer" xmlns="http://www.w3.org/2000/svg"></svg>
        <div class="canvas-grid"></div>
      </section>
    </main>
  </div>

  <script>
    (function() {
      const canvas = document.getElementById('canvas');
      const connectorLayer = document.getElementById('connector-layer');
      const toolText = document.getElementById('tool-text');
      const btnClear = document.getElementById('btn-clear');

      let zIndexCounter = 10;
      let cardIdCounter = 0;
      let currentSelectedCard = null;
      let connectors = [];
      let connectorStartCard = null;

      const hasPointer = window.PointerEvent !== undefined;

      function addDrag(handle, onStart, onMove, onEnd) {
        let active = false;
        let lastX = 0;
        let lastY = 0;

        function start(x, y, rawEvent) {
          active = true;
          lastX = x;
          lastY = y;
          if (onStart) onStart(rawEvent);
        }

        function move(x, y, rawEvent) {
          if (!active) return;
          const dx = x - lastX;
          const dy = y - lastY;
          lastX = x;
          lastY = y;
          onMove(dx, dy, rawEvent);
        }

        function end(rawEvent) {
          if (!active) return;
          active = false;
          if (onEnd) onEnd(rawEvent);
        }

        if (hasPointer) {
          handle.addEventListener('pointerdown', (e) => {
            if (e.button !== 0 && e.button !== undefined) return;
            handle.setPointerCapture(e.pointerId);
            start(e.clientX, e.clientY, e);
            e.preventDefault();
          });
          handle.addEventListener('pointermove', (e) => {
            if (!active) return;
            move(e.clientX, e.clientY, e);
          });
          handle.addEventListener('pointerup', (e) => {
            end(e);
            handle.releasePointerCapture(e.pointerId);
          });
          handle.addEventListener('pointercancel', (e) => {
            end(e);
            try { handle.releasePointerCapture(e.pointerId); } catch (_) {}
          });
        } else {
          // mouse
          handle.addEventListener('mousedown', (e) => {
            if (e.button !== 0) return;
            start(e.clientX, e.clientY, e);
            document.addEventListener('mousemove', mouseMove);
            document.addEventListener('mouseup', mouseUp);
            e.preventDefault();
          });
          function mouseMove(e) {
            move(e.clientX, e.clientY, e);
          }
          function mouseUp(e) {
            document.removeEventListener('mousemove', mouseMove);
            document.removeEventListener('mouseup', mouseUp);
            end(e);
          }

          // touch
          handle.addEventListener('touchstart', (e) => {
            const t = e.touches[0];
            if (!t) return;
            start(t.clientX, t.clientY, e);
            document.addEventListener('touchmove', touchMove, { passive: false });
            document.addEventListener('touchend', touchEnd);
            e.preventDefault();
          });
          function touchMove(e) {
            const t = e.touches[0];
            if (!t) return;
            move(t.clientX, t.clientY, e);
            e.preventDefault();
          }
          function touchEnd(e) {
            document.removeEventListener('touchmove', touchMove);
            document.removeEventListener('touchend', touchEnd);
            end(e);
          }
        }
      }

      function bringToFront(card) {
        zIndexCounter++;
        card.style.zIndex = zIndexCounter;
        if (currentSelectedCard && currentSelectedCard !== card) {
          currentSelectedCard.classList.remove('selected');
        }
        card.classList.add('selected');
        currentSelectedCard = card;
        updateConnectors();
      }

      function toggleCollapse(card, btn) {
        const isCollapsed = card.classList.contains('collapsed');
        if (isCollapsed) {
          card.classList.remove('collapsed');
          if (card.dataset.prevHeight) {
            card.style.height = card.dataset.prevHeight;
          }
          btn.innerHTML = 'â–¾';
        } else {
          card.dataset.prevHeight = card.style.height || (card.getBoundingClientRect().height + 'px');
          card.classList.add('collapsed');
          btn.innerHTML = 'â–´';
        }
        updateConnectors();
      }

      function centerCard(card) {
        const rect = canvas.getBoundingClientRect();
        const cardRect = card.getBoundingClientRect();
        const left = rect.left + (rect.width - cardRect.width) / 2;
        const top = rect.top + (rect.height - cardRect.height) / 2;
        card.style.left = (left - rect.left) + 'px';
        card.style.top = (top - rect.top) + 'px';
        updateConnectors();
      }

      function handleConnectorClick(card) {
        if (!connectorStartCard) {
          connectorStartCard = card;
          bringToFront(card);
        } else if (connectorStartCard === card) {
          connectorStartCard = null;
        } else {
          createConnector(connectorStartCard, card);
          connectorStartCard = null;
        }
      }

      function createConnector(fromCard, toCard) {
        const fromId = fromCard.dataset.cardId;
        const toId = toCard.dataset.cardId;
        if (!fromId || !toId || fromId === toId) return;

        if (connectors.some(c => c.fromId === fromId && c.toId === toId)) return;

        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('class', 'connector-path');

        const id = 'conn-' + Date.now() + '-' + Math.random().toString(36).slice(2);
        path.dataset.connectorId = id;
        connectorLayer.appendChild(path);

        const conn = { id, fromId, toId, pathEl: path };
        connectors.push(conn);

        // tap / click per eliminare
        path.addEventListener('click', () => {
          removeConnectorById(id);
        });

        updateConnectors();
      }

      function removeConnectorById(id) {
        const idx = connectors.findIndex(c => c.id === id);
        if (idx === -1) return;
        const conn = connectors[idx];
        if (conn.pathEl && conn.pathEl.parentNode) {
          conn.pathEl.parentNode.removeChild(conn.pathEl);
        }
        connectors.splice(idx, 1);
      }

      function removeConnectorsForCard(cardId) {
        const remaining = [];
        connectors.forEach(c => {
          if (c.fromId === cardId || c.toId === cardId) {
            if (c.pathEl && c.pathEl.parentNode) {
              c.pathEl.parentNode.removeChild(c.pathEl);
            }
          } else {
            remaining.push(c);
          }
        });
        connectors = remaining;
      }

      function updateConnectors() {
        const canvasRect = canvas.getBoundingClientRect();
        const toRemove = [];

        connectors.forEach(conn => {
          const fromCard = canvas.querySelector('.desk-card[data-card-id="' + conn.fromId + '"]');
          const toCard = canvas.querySelector('.desk-card[data-card-id="' + conn.toId + '"]');
          if (!fromCard || !toCard) {
            toRemove.push(conn.id);
            return;
          }

          const fromRect = fromCard.getBoundingClientRect();
          const toRect = toCard.getBoundingClientRect();

          const startX = fromRect.right - canvasRect.left;
          const startY = fromRect.top + fromRect.height / 2 - canvasRect.top;
          const endX = toRect.left - canvasRect.left;
          const endY = toRect.top + toRect.height / 2 - canvasRect.top;

          const offset = Math.max(40, Math.abs(endX - startX) / 3);

          const d = [
            'M', startX, startY,
            'C', startX + offset, startY,
                 endX - offset, endY,
                 endX, endY
          ].join(' ');

          conn.pathEl.setAttribute('d', d);
        });

        toRemove.forEach(removeConnectorById);
      }

      window.addEventListener('resize', updateConnectors);

      function createCardBase(type, title) {
        const card = document.createElement('div');
        card.className = 'desk-card';
        card.dataset.cardId = String(++cardIdCounter);
        card.dataset.type = type;
        card.style.left = (40 + Math.random() * 80) + 'px';
        card.style.top = (40 + Math.random() * 80) + 'px';
        card.style.width = '320px';
        card.style.height = '200px';
        card.style.zIndex = zIndexCounter;

        const header = document.createElement('div');
        header.className = 'card-header';

        const headerLeft = document.createElement('div');
        headerLeft.className = 'card-header-left';

        const icon = document.createElement('div');
        icon.className = 'card-type-icon';
        icon.textContent = 'T';

        const titleEl = document.createElement('div');
        titleEl.className = 'card-title';
        titleEl.textContent = title || 'Nota';

        headerLeft.appendChild(icon);
        headerLeft.appendChild(titleEl);

        const headerActions = document.createElement('div');
        headerActions.className = 'card-header-actions';

        const toggleButton = document.createElement('button');
        toggleButton.className = 'icon-button';
        toggleButton.title = 'Apri/chiudi contenuto';
        toggleButton.innerHTML = 'â–¾';

        const centerButton = document.createElement('button');
        centerButton.className = 'icon-button';
        centerButton.title = 'Centra nel desk';
        centerButton.innerHTML = 'â—';

        const closeButton = document.createElement('button');
        closeButton.className = 'icon-button danger';
        closeButton.title = 'Elimina';
        closeButton.innerHTML = 'âœ•';

        headerActions.appendChild(toggleButton);
        headerActions.appendChild(centerButton);
        headerActions.appendChild(closeButton);

        header.appendChild(headerLeft);
        header.appendChild(headerActions);

        const body = document.createElement('div');
        body.className = 'card-body';

        const bodyInner = document.createElement('div');
        bodyInner.className = 'card-body-inner';
        body.appendChild(bodyInner);

        const resize = document.createElement('div');
        resize.className = 'resize-handle';

        const connectorHandle = document.createElement('div');
        connectorHandle.className = 'connector-handle';

        card.appendChild(header);
        card.appendChild(body);
        card.appendChild(resize);
        card.appendChild(connectorHandle);

        canvas.appendChild(card);

        // drag card
        addDrag(
          header,
          () => {
            bringToFront(card);
          },
          (dx, dy) => {
            const rect = card.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();
            const left = rect.left - canvasRect.left + dx;
            const top = rect.top - canvasRect.top + dy;
            card.style.left = left + 'px';
            card.style.top = top + 'px';
            updateConnectors();
          }
        );

        // resize
        addDrag(
          resize,
          () => {
            bringToFront(card);
          },
          (dx, dy) => {
            const rect = card.getBoundingClientRect();
            const newWidth = Math.max(220, rect.width + dx);
            const newHeight = Math.max(140, rect.height + dy);
            card.style.width = newWidth + 'px';
            card.style.height = newHeight + 'px';
            updateConnectors();
          }
        );

        // selezione card
        card.addEventListener('pointerdown', () => bringToFront(card));
        card.addEventListener('mousedown', () => bringToFront(card)); // fallback

        // toggle open/close
        toggleButton.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleCollapse(card, toggleButton);
        });

        header.addEventListener('dblclick', (e) => {
          e.stopPropagation();
          toggleCollapse(card, toggleButton);
        });

        // center
        centerButton.addEventListener('click', (e) => {
          e.stopPropagation();
          centerCard(card);
        });

        // close
        closeButton.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = card.dataset.cardId;
          removeConnectorsForCard(id);
          card.remove();
          if (currentSelectedCard === card) currentSelectedCard = null;
          updateConnectors();
        });

        // connector handle
        connectorHandle.addEventListener('click', (e) => {
          e.stopPropagation();
          handleConnectorClick(card);
        });

        return { card, bodyInner };
      }

      function createTextCard(initialText) {
        const { card, bodyInner } = createCardBase('text', 'Nota');
        const text = document.createElement('div');
        text.className = 'card-text-content';
        text.contentEditable = 'true';
        text.innerHTML = initialText || '';
        bodyInner.appendChild(text);
        bringToFront(card);
        updateConnectors();
        return card;
      }

      toolText.addEventListener('click', () => {
        createTextCard('Scrivi qui la tua notaâ€¦');
      });

      btnClear.addEventListener('click', () => {
        const cards = canvas.querySelectorAll('.desk-card');
        cards.forEach(c => c.remove());
        connectors.forEach(c => {
          if (c.pathEl && c.pathEl.parentNode) {
            c.pathEl.parentNode.removeChild(c.pathEl);
          }
        });
        connectors = [];
        currentSelectedCard = null;
        connectorStartCard = null;
      });

      // card di esempio
      window.addEventListener('load', () => {
        createTextCard('Card di prova: sposta, ridimensiona, apri/chiudi, collega.');
        createTextCard('Seconda card: prova i connettori tra questa e lâ€™altra.');
      });
    })();
  </script>
</body>
</html>
